#include <fcntl.h>
#include <stdlib.h>
#include <sys/time.h>

#include "SDL.h"

#define XSIZE 640
#define YSIZE 480
SDL_Surface *thescreen;

#define PIECESIZE (21*6)

int grey,white,blue;
int showingblocks=0;
int left;

void clear(void)
{
	memset(thescreen->pixels,0,XSIZE*YSIZE*2);
}
void colordot(int x,int y,int c)
{
	*((unsigned short *)thescreen->pixels+y*thescreen->pitch/2+x)=c;
}

void randomize(void)
{
struct timeval tv;
	gettimeofday(&tv,0);
	srand(tv.tv_sec+tv.tv_usec);
}
scrlock()
{
	if(SDL_MUSTLOCK(thescreen))
	{
		if ( SDL_LockSurface(thescreen) < 0 )
		{
			fprintf(stderr, "Couldn't lock display surface: %s\n",
								SDL_GetError());
			return;
		}
	}
}
scrunlock()
{
	if(SDL_MUSTLOCK(thescreen))
		SDL_UnlockSurface(thescreen);
	else
		SDL_UpdateRect(thescreen, 0, 0, 0, 0);
}

unsigned long maprgb(int r,int g,int b)
{
	return SDL_MapRGB(thescreen->format,r,g,b);
}

#define NUMPIECES (sizeof(pieces)/PIECESIZE)

unsigned char pieces[16][PIECESIZE]={
0xff,0xff,0xff,0xff,0x03,0x00,
0xff,0xff,0xff,0xff,0x01,0x00,
0xff,0xff,0xff,0xff,0x00,0x00,
0xff,0xff,0xff,0x7f,0x00,0x00,
0xff,0xff,0xff,0x3f,0x00,0x00,
0xff,0xff,0xff,0x1f,0x00,0x00,
0xff,0xff,0xff,0x0f,0x00,0x00,
0xff,0xff,0xff,0x07,0x00,0x00,
0xff,0xff,0xff,0x03,0x00,0x00,
0xff,0xff,0xff,0x01,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,

0xff,0xff,0x7f,0xfe,0xff,0xff,
0xff,0xff,0x3f,0xfc,0xff,0xff,
0xff,0xff,0x0f,0xf0,0xff,0xff,
0xff,0xff,0x03,0xc0,0xff,0xff,
0xff,0xff,0x00,0x00,0xff,0xff,
0xff,0x3f,0x00,0x00,0xfc,0xff,
0xff,0x0f,0x00,0x00,0xf0,0xff,
0xff,0x03,0x00,0x00,0xc0,0xff,
0xff,0x00,0x00,0x00,0x00,0xff,
0x3f,0x00,0x00,0x00,0x00,0xfc,
0x0f,0x00,0x00,0x00,0x00,0xf0,
0x3f,0x00,0x00,0xfe,0xff,0xc0,
0xff,0x00,0x00,0xfe,0xff,0x00,
0xff,0x03,0x00,0xfe,0xff,0x00,
0xff,0x0f,0x00,0xfe,0xff,0x00,
0xff,0x3f,0x00,0xfe,0xff,0x00,
0xff,0xff,0x00,0xfe,0xff,0x00,
0xff,0xff,0x03,0x00,0x00,0x00,
0xff,0xff,0x0f,0x00,0x00,0x00,
0xff,0xff,0x3f,0x00,0x00,0x00,
0xff,0xff,0xff,0x00,0x00,0x00,

0xff,0xff,0xff,0x83,0x0f,0xfe,
0xff,0xff,0xff,0x83,0x0f,0xfe,
0xff,0xff,0xff,0x83,0x0f,0xfe,
0xff,0xff,0xff,0x83,0x0f,0xfe,
0x00,0x00,0x00,0x80,0x0f,0xfe,
0x00,0x00,0x00,0x80,0x0f,0xfe,
0x00,0x00,0x00,0x80,0x0f,0xfe,
0x00,0x00,0x00,0x80,0x0f,0xfe,
0xff,0xff,0xff,0xff,0x0f,0xfe,
0xff,0xff,0xff,0xff,0x0f,0xfe,
0xff,0xff,0xff,0xff,0x0f,0xfe,
0xff,0xff,0xff,0xff,0x0f,0xfe,
0x00,0x00,0x00,0x00,0x00,0xfe,
0x00,0x00,0x00,0x00,0x00,0xfe,
0x00,0x00,0x00,0x00,0x00,0xfe,
0x00,0x00,0x00,0x00,0x00,0xfe,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,

0x00,0xf0,0x0f,0xfc,0x03,0x7f,
0x00,0xf8,0x07,0xfe,0x81,0x7f,
0x00,0xfc,0x03,0xff,0xc0,0x3f,
0x00,0xfe,0x81,0x7f,0xe0,0x1f,
0x00,0xff,0xc0,0x3f,0xf0,0x0f,
0x80,0x7f,0xe0,0x1f,0xf8,0x07,
0xc0,0x3f,0xf0,0x0f,0xfc,0x03,
0xe0,0x1f,0xf8,0x07,0xfe,0x01,
0xf0,0x0f,0xfc,0x03,0xff,0x00,
0xf8,0x07,0xfe,0x81,0x7f,0x00,
0xfc,0x03,0xff,0xc0,0x3f,0x00,
0xfe,0x81,0x7f,0xe0,0x1f,0x00,
0x00,0x00,0x00,0xf0,0x0f,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x30,0xc0,0x00,0x03,0x0c,0x30,
0x78,0xe0,0x81,0x07,0x1e,0x78,
0xfc,0xf0,0xc3,0x0f,0x3f,0xfc,
0xfe,0xf9,0xe7,0x9f,0x7f,0xfe,
0xff,0xff,0xff,0xff,0xff,0xff,

0xff,0x07,0x00,0x00,0x80,0xff,
0xff,0x0f,0x00,0x00,0x00,0xfe,
0xff,0x0f,0x00,0x00,0x00,0xf8,
0xff,0x07,0x1e,0x00,0x00,0xf0,
0xff,0x03,0x3f,0x00,0x00,0xe0,
0xff,0x80,0x7f,0x00,0x00,0xe0,
0xff,0xc0,0x7f,0x00,0x00,0xc0,
0xff,0xc0,0x7f,0x00,0x00,0x80,
0xff,0xe1,0x3f,0xf0,0x01,0x80,
0xff,0xff,0x1f,0xf8,0x07,0x00,
0xff,0xff,0x07,0xfc,0x0f,0x00,
0xff,0xff,0x03,0xfe,0x1f,0x00,
0xff,0xff,0x03,0xfe,0x1f,0x00,
0xff,0xff,0x07,0xff,0x1f,0x00,
0xff,0xff,0xff,0xff,0x1f,0x00,
0xff,0xff,0xff,0x7f,0x0e,0x00,
0xff,0xff,0xff,0x3f,0x00,0x00,
0xff,0xff,0xff,0x1f,0x00,0x00,
0xff,0xff,0xff,0x1f,0x00,0x00,
0xff,0xff,0xff,0x3f,0x00,0x00,
0xff,0xff,0xff,0x7f,0x00,0x00,

0x00,0xfe,0x01,0x7e,0x00,0x00,
0x00,0xff,0x00,0xff,0x00,0x00,
0x00,0xff,0x00,0xff,0x00,0x00,
0x80,0x7f,0x80,0xff,0x01,0x00,
0x80,0x7f,0x80,0xff,0x01,0x00,
0xc0,0x3f,0xc0,0xff,0x03,0x00,
0xc0,0x3f,0xc0,0xff,0x03,0x00,
0xe0,0x1f,0xe0,0xff,0x07,0x00,
0xe0,0x1f,0xe0,0xff,0x07,0x00,
0xf0,0x0f,0xf0,0xff,0x0f,0x00,
0xf0,0x0f,0xf0,0xff,0x0f,0x00,
0xf8,0x07,0xf8,0xe7,0x1f,0x00,
0xf8,0x07,0xf8,0xe7,0x1f,0x00,
0xfc,0x03,0xfc,0xc3,0x3f,0x00,
0xfc,0x03,0xfc,0xc3,0x3f,0x00,
0xfe,0x01,0xfe,0x81,0x7f,0x00,
0xfe,0x01,0xfe,0x81,0x7f,0x00,
0xff,0x00,0xff,0x00,0xff,0x00,
0xff,0x00,0xff,0x00,0xff,0x00,
0x7f,0x80,0x7f,0x00,0xfe,0x01,
0x7f,0x80,0x7f,0x00,0xfe,0x01,

0xfe,0xff,0x7f,0x00,0xfe,0x01,
0xff,0xff,0xff,0x00,0xfe,0x01,
0xff,0xff,0xff,0x00,0xfe,0x01,
0xfe,0xff,0xff,0x00,0xfe,0x01,
0xfe,0xff,0xff,0x00,0xfe,0x01,
0xfc,0xff,0x7f,0x00,0xff,0x01,
0xf8,0xff,0x7f,0x00,0xff,0x01,
0xf0,0xff,0x3f,0x00,0xff,0x01,
0xe0,0xff,0x1f,0x00,0xff,0x00,
0x80,0xff,0x07,0x80,0xff,0x00,
0x00,0xfc,0x00,0x80,0xff,0x00,
0x00,0x00,0x00,0xc0,0xff,0x00,
0x00,0x00,0x00,0xe0,0x7f,0x80,
0x00,0x00,0x00,0xf0,0x7f,0x80,
0x00,0x00,0x00,0xfc,0x7f,0xc0,
0x00,0x00,0x00,0xff,0x3f,0xc0,
0x00,0x00,0xc0,0xff,0x3f,0xe0,
0x00,0x00,0xf8,0xff,0x1f,0xe0,
0x00,0x80,0xff,0xff,0x0f,0xf0,
0x00,0xfe,0xff,0xff,0x03,0xf8,
0xf8,0xff,0xff,0xff,0x00,0xfe,

0x80,0x0f,0x00,0x00,0x00,0x00,
0x80,0x0f,0x00,0x00,0x00,0x00,
0x80,0x0f,0x00,0x00,0x00,0x00,
0x80,0x0f,0x00,0x00,0x00,0x00,
0x80,0x0f,0x00,0x00,0x00,0x00,
0x80,0x0f,0xfe,0xff,0xff,0x01,
0x80,0x0f,0xfe,0xff,0xff,0x01,
0x80,0x0f,0xfe,0xff,0xff,0x01,
0x80,0x0f,0xfe,0xff,0xff,0x01,
0x80,0x0f,0x00,0x00,0xf0,0x01,
0x80,0x0f,0x00,0x00,0xf0,0x01,
0x80,0x0f,0x00,0x00,0xf0,0x01,
0x80,0xff,0xff,0xff,0xff,0x01,
0x80,0xff,0xff,0xff,0xff,0x01,
0x80,0xff,0xff,0xff,0xff,0x01,
0x80,0xff,0xff,0xff,0xff,0x01,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,

0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x80,0x01,0x80,0x01,0x00,0x00,
0xc0,0x03,0xc0,0x03,0x00,0x00,
0xe0,0x07,0xe0,0x07,0x00,0x00,
0xf0,0x0f,0xf0,0x0f,0x00,0x00,
0xf8,0x1f,0xf8,0xff,0xff,0xff,
0xfc,0x3f,0xfc,0xff,0xff,0xff,
0xfe,0x7f,0xfe,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0x7f,0xfe,0x7f,0xfe,0xff,0xff,
0x3f,0xfc,0x3f,0xfc,0xff,0xff,
0x1f,0xf8,0x1f,0xf8,0xff,0xff,
0x0f,0xf0,0x0f,0x00,0x00,0x00,
0x07,0xe0,0x07,0x00,0x00,0x00,
0x03,0xc0,0x03,0x00,0x00,0x00,
0x01,0x80,0x01,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,

0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0xff,0xff,0xff,0xff,0xff,0xff,
0x00,0x00,0x00,0xff,0x0f,0x00,
0x00,0x00,0x00,0xff,0x0f,0x00,
0x00,0x00,0x00,0xff,0x0f,0x00,
0x00,0x00,0x00,0xff,0x0f,0x00,
0x00,0x00,0x00,0xff,0x0f,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,

0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xfc,0x1f,0xf8,0xff,0x03,
0x00,0xff,0x1f,0xf8,0xff,0x03,
0x80,0xff,0x1f,0xf8,0xff,0x03,
0x80,0xff,0x1f,0xf8,0xff,0x03,
0xc0,0xff,0x1f,0xf8,0xff,0x03,
0xc0,0xff,0x1f,0xf8,0xff,0x03,
0xc0,0xff,0x1f,0xf8,0xff,0x03,
0xc0,0xff,0x1f,0xf8,0xff,0x03,
0xc0,0xff,0x1f,0xf8,0xff,0x03,
0x80,0xff,0x1f,0xf0,0xff,0x01,
0x80,0xff,0x1f,0xf0,0xff,0x01,
0x00,0xff,0x1f,0xe0,0xff,0x00,
0x00,0xfc,0x1f,0x80,0x3f,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,

0xff,0x01,0x00,0x00,0xfc,0xff,
0xff,0x00,0x06,0x00,0xf0,0xff,
0x7f,0x00,0x1f,0x00,0xc0,0xff,
0x3f,0x80,0x7f,0x00,0x00,0xff,
0x1f,0x00,0xff,0x01,0x00,0xfc,
0x0f,0x00,0xfc,0x07,0x00,0xf0,
0x0f,0x00,0xf0,0x1f,0x00,0xc0,
0x1f,0x00,0xc0,0x7f,0x00,0x00,
0x7f,0x00,0x00,0xff,0x01,0x00,
0xff,0x01,0x00,0xfc,0x07,0x00,
0xff,0x07,0x00,0xf0,0x1f,0x00,
0xff,0x1f,0x00,0xc0,0x3f,0x00,
0xff,0x7f,0x00,0x00,0x1f,0x80,
0xff,0xff,0x01,0x00,0x0c,0xc0,
0xff,0xff,0x07,0x00,0x00,0xe0,
0xff,0xff,0x1f,0x00,0x00,0xf0,
0xff,0xff,0x7f,0x00,0x00,0xf8,
0xff,0xff,0xff,0x01,0x00,0xfc,
0xff,0xff,0xff,0x07,0x00,0xfe,
0xff,0xff,0xff,0x1f,0x00,0xff,
0xff,0xff,0xff,0x7f,0x80,0xff,

0x7f,0x00,0x00,0x00,0x00,0x00,
0xff,0x00,0x00,0x00,0x00,0x00,
0xfe,0x00,0x00,0x00,0x00,0x00,
0xfe,0x01,0x00,0x00,0x00,0x00,
0xfc,0x01,0x00,0x00,0x00,0x00,
0xfc,0x03,0x00,0xfc,0xff,0x01,
0xf8,0x03,0x00,0xfe,0xff,0x03,
0xf8,0x07,0x00,0xff,0xff,0x07,
0xf0,0x07,0x80,0xff,0xff,0x0f,
0xf0,0x0f,0xc0,0xff,0xff,0x1f,
0xe0,0x0f,0xe0,0x0f,0xf0,0x0f,
0xe0,0xff,0xff,0x07,0xf8,0x07,
0xc0,0xff,0xff,0x03,0xfc,0x03,
0xc0,0xff,0xff,0x01,0xfe,0x01,
0x80,0xff,0xff,0x00,0xff,0x00,
0x80,0xff,0x7f,0x80,0x7f,0x00,
0x00,0x00,0x00,0xc0,0x3f,0x00,
0x00,0x00,0x00,0xe0,0x1f,0x00,
0x00,0x00,0x00,0xf0,0x0f,0x00,
0x00,0x00,0x00,0xf8,0x07,0x00,
0x00,0x00,0x00,0xfc,0x03,0x00,

0xff,0x01,0xfc,0x0f,0x80,0xff,
0xff,0x01,0xfe,0x07,0xe0,0xff,
0xff,0x00,0xff,0x03,0xf8,0xff,
0xff,0x80,0xff,0x01,0xfe,0xff,
0x7f,0x80,0xff,0x00,0xff,0x7f,
0x7f,0xc0,0x7f,0x80,0xff,0x1f,
0x3f,0xc0,0x3f,0xc0,0xff,0x07,
0x3f,0xe0,0x1f,0xe0,0xff,0x01,
0x1f,0xe0,0x1f,0xf0,0x7f,0x00,
0x1f,0xf0,0x0f,0xf0,0x3f,0x00,
0x0f,0xf0,0x0f,0xf8,0x1f,0x80,
0x0f,0xf8,0x07,0xfc,0x0f,0xc0,
0x0f,0xf8,0x07,0xfc,0x07,0xf0,
0x07,0xfc,0x03,0xfe,0x03,0xf8,
0x07,0xfc,0x03,0xfe,0x01,0xfc,
0x07,0xfc,0x01,0xff,0x01,0xfe,
0x03,0xfe,0x01,0xff,0x00,0xff,
0x03,0xfe,0x01,0xff,0x80,0xff,
0x03,0xfe,0x80,0x7f,0x80,0xff,
0x03,0xfe,0x80,0x7f,0xc0,0xff,
0x03,0xfe,0x80,0x7f,0xc0,0xff,

0x00,0x7c,0xc0,0x07,0xff,0xff,
0x00,0x7c,0xe0,0x03,0xf8,0xff,
0x01,0x3e,0xe0,0x03,0xc0,0xff,
0x1f,0x3e,0xf0,0x1f,0x00,0xfe,
0xff,0x1f,0xf0,0xff,0x00,0xf0,
0xff,0x1f,0x80,0xff,0x07,0x80,
0xfc,0x3f,0x00,0xfc,0x3f,0x00,
0xe0,0xff,0x01,0xe0,0xff,0x01,
0xc0,0xff,0x0f,0x00,0xff,0x0f,
0xc0,0xff,0x7f,0x00,0xf8,0x7f,
0xe0,0xc3,0xff,0x03,0xc0,0xff,
0xe0,0x03,0xfe,0x1f,0x00,0xfe,
0xf0,0x01,0xf0,0xff,0x00,0xf0,
0xf0,0x01,0x80,0xff,0x07,0x80,
0xf8,0x00,0x00,0xfc,0x3f,0x00,
0xf8,0xc0,0x01,0xe0,0xff,0x01,
0x7c,0xe0,0x0f,0x00,0xff,0x0f,
0x7c,0xe0,0x7f,0x00,0xf8,0x7f,
0x3e,0xf0,0xff,0x03,0xc0,0xff,
0x3e,0xf0,0xff,0x1f,0x00,0xfe,
0x1f,0xf8,0xff,0xff,0x00,0xf0,

0xff,0xff,0x3f,0x00,0x00,0x00,
0xff,0xff,0x3f,0x00,0x00,0x00,
0xff,0xff,0x3f,0x00,0x00,0x00,
0xff,0xff,0x3f,0x00,0x00,0x00,
0xff,0xff,0x1f,0x00,0x00,0x00,
0xff,0xff,0x0f,0x00,0x00,0x00,
0xff,0xff,0x07,0x3c,0x00,0x00,
0xff,0xff,0x07,0x7f,0x00,0x00,
0xff,0xff,0x8f,0xff,0x00,0x00,
0xff,0xff,0xff,0xff,0x00,0x00,
0xff,0xff,0xff,0xff,0x00,0x00,
0xff,0xff,0xff,0xff,0x00,0x00,
0xff,0xff,0xff,0x7f,0x00,0x00,
0xff,0xff,0xc7,0x7f,0x00,0x00,
0xff,0xff,0x03,0x3f,0x00,0x00,
0xff,0xff,0x01,0x00,0x00,0x00,
0xff,0xff,0x01,0x00,0x00,0x00,
0xff,0xff,0x03,0x00,0x00,0x00,
0xff,0xff,0x03,0x00,0x00,0x00,
0xff,0xff,0x01,0x00,0x00,0x00,
0xff,0xff,0x01,0x00,0x00,0x00,
};

void renderpiece(int x,int y,unsigned char *p,int color)
{
int j,k,u,v;
int tx,ty,tc;

	for(v=0;v<21;++v)
	{
		ty=y+2*v+1;
		for(u=0;u<6;++u)
		{
			for(j=0;j<8;++j)
			{
				tc=(*p&(1<<j)) ? color : 0;
				tx=x+2*(u*8+j)+1;
				colordot(tx+0,ty+0,tc);
				colordot(tx+1,ty+0,tc);
				colordot(tx+0,ty+1,tc);
				colordot(tx+1,ty+1,tc);
			}
			++p;
		}
	}
	for(j=0;j<98;++j)
	{
		if(j<42)
		{
			colordot(x,y+j+1,blue);
			colordot(x+97,y+j+1,blue);
		}
		colordot(x+j,y,blue);
		colordot(x+j,y+43,blue);
	}
}

void not(unsigned char *dest,unsigned char *src)
{
int i;
	for(i=0;i<PIECESIZE;++i)
		dest[i]=~src[i];
}
void and(unsigned char *dest,unsigned char *src1,unsigned char *src2)
{
int i;
	for(i=0;i<PIECESIZE;++i)
		dest[i]=src1[i]&src2[i];
}
void or(unsigned char *dest,unsigned char *src1,unsigned char *src2)
{
int i;
	for(i=0;i<PIECESIZE;++i)
		dest[i]=src1[i]|src2[i];
}
unsigned char bitreverse(unsigned char v)
{
	return ((v&0x80)>>7) | ((v&0x40)>>5) | ((v&0x20)>>3) | ((v&0x10)>>1) |
		((v&0x08)<<1) | ((v&0x04)<<3) | ((v&0x02)<<5) | ((v&0x01)<<7);
}

void randflip(unsigned char *dest)
{
int i,j,k,t;
unsigned char line[24],*p1,*p2;
	t=rand();
	if(t&1)
	{
		for(j=0;j<11;++j)
		{
			p1=dest+j*6;
			p2=dest+(21-1-j)*6;
			memcpy(line,p1,6);
			memcpy(p1,p2,6);
			memcpy(p2,line,6);
		}
	}
	if(t&2)
	{
		for(j=0;j<21;++j)
		{
			p1=dest+j*6;
			memcpy(line,p1,6);
			for(i=0;i<6;++i)
				p1[i]=bitreverse(line[5-i]);
		}
	}
	if(t&4)
	{
		not(dest,dest);
	}
}
void makepiece(unsigned char result[][PIECESIZE],int p1,int p2,int p3)
{
unsigned char temp1[PIECESIZE];
unsigned char temp2[PIECESIZE];
unsigned char temp3[PIECESIZE];
unsigned char temp4[PIECESIZE];

	memcpy(temp1,pieces[p1],PIECESIZE);
	randflip(temp1);
	not(temp2,temp1);
	memcpy(temp3,pieces[p2],PIECESIZE);
	randflip(temp3);
	not(temp4,temp3);
	and(result[0],temp1,temp3);
	and(result[1],temp1,temp4);
	memcpy(temp3,pieces[p3],PIECESIZE);
	randflip(temp3);
	not(temp4,temp3);
	and(result[2],temp2,temp3);
	and(result[3],temp2,temp4);
}

#define PXSIZE 100
#define PYSIZE 50

unsigned char built[36][PIECESIZE];
int shuffle[36];
int selected[36];
unsigned char mask[PIECESIZE];

void build(void)
{
int i,j,j2,j3,k,t;
unsigned char result[4][PIECESIZE];
int flags[16];
unsigned char temp1[PIECESIZE];
unsigned char temp2[PIECESIZE];


top:
	memset(shuffle,~0,sizeof(shuffle));
	memset(selected,0,sizeof(selected));
	memset(flags,0,sizeof(flags));

	t=0;
	for(i=0;i<9;++i)
	{
		do j=rand()&15; while(flags[j]);
		flags[j]=1;

		do j2=rand()&15; while(j2==j);
		do j3=rand()&15; while(j3==j);

		makepiece(result,j,j2,j3);
		for(j=0;j<4;++j)
		{
			do k=rand()%36; while(shuffle[k]>=0);
			shuffle[k]=t++;
			memcpy(built[k],result[j],PIECESIZE);
			++k;
		}
	}
	memset(temp1,0,sizeof(temp1));
	not(temp1,temp1);
	for(i=0;i<36;++i)
	{
		and(temp2,temp1,built[i]);
		for(j=0;j<PIECESIZE;++j)
			if(temp2[j]) break;
		if(j==PIECESIZE) goto top;
	}
	left=36;
}

void display(void)
{
int i;
	scrlock();
	clear();
	if(!showingblocks)
	{
		for(i=0;i<36;++i)
		{
			if(selected[i]&2) continue;
			renderpiece((i%4)*PXSIZE,(i/4)*PYSIZE,built[i],
				selected[i] ? white : grey);
		}
		renderpiece(5*PXSIZE,YSIZE/2-PYSIZE/2,mask,white);
	} else
	{
		for(i=0;i<NUMPIECES;++i)
			renderpiece((i%4)*PXSIZE,(i/4)*PYSIZE,pieces[i],grey);
	}
	scrunlock();
}

void hit(int x,int y)
{
int where;
int i;
unsigned char temp1[PIECESIZE];
unsigned char temp2[PIECESIZE];
unsigned long long m;

	x/=PXSIZE;
	y/=PYSIZE;
	if(x>=4 || y>=9)
	{
		for(i=0;i<36;++i) selected[i]&=~1;
	} else
	{
		where=4*y+x;
		if(selected[where]&2) return;
		if(selected[where]&1)
			selected[where]^=1;
		else
		{
			memset(temp1,0,sizeof(temp1));
			not(temp1,temp1);
			and(temp1,temp1,mask);
			and(temp1,temp1,built[where]);
			for(i=0;i<PIECESIZE;++i)
				if(temp1[i]) return;
			selected[where]|=1;
		}
	}

	m=0;
	for(i=0;i<36;++i)
	{
		if(~selected[i]&1) continue;
		m|=1ll<<shuffle[i];
	}
	while(m) if(m&15) break; else m>>=4;
	if(m==15)
	{
		for(i=0;i<36;++i)
		{
			if(~selected[i]&1) continue;
			selected[i]=2;
		}
		left-=4;
	}

	memset(mask,0,sizeof(mask));
	for(i=0;i<36;++i)
	{
		if(~selected[i]&1) continue;
		or(mask,mask,built[i]);
	}
	display();
}


main(int argc,char **argv)
{
int code;
int mousex,mousey;
int done=0;
SDL_Event event;
unsigned long videoflags;

	randomize();
	if ( SDL_Init(SDL_INIT_VIDEO) < 0 )
	{
		fprintf(stderr, "Couldn't initialize SDL: %s\n",SDL_GetError());
		exit(1);
	}
	videoflags = 0;
	thescreen = SDL_SetVideoMode(XSIZE, YSIZE, 16, videoflags);
	if ( thescreen == NULL )
	{
		fprintf(stderr, "Couldn't set display mode: %s\n",
							SDL_GetError());
		exit(5);
	}

	grey=maprgb(192,192,192);
	white=maprgb(255,255,255);
	blue=maprgb(0,0,255);
	build();
	display();
	while(!done)
	{
		usleep(50000);
		while(SDL_PollEvent(&event))
		{
			switch(event.type)
			{
			case SDL_MOUSEMOTION:
				mousex=event.motion.x;
				mousey=event.motion.y;
				break;
			case SDL_MOUSEBUTTONDOWN:
				if(!left) {build();display();}
				else
					hit(mousex,mousey);
				break;
			case SDL_KEYDOWN:
				code=event.key.keysym.sym;
				if(code==SDLK_ESCAPE) done=1;
				if(code==SDLK_RETURN)
				{
					showingblocks=!showingblocks;
					display();
				}
				break;
			}
		}
	}
}
