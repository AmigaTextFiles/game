// 1. INCLUDES -----------------------------------------------------------

#ifdef __amigaos4__
    #ifndef __USE_INLINE__
        #define __USE_INLINE__ // define this as early as possible
    #endif
#endif
#ifdef __LCLINT__
    typedef char* STRPTR;
    typedef char* CONST_STRPTR;
    typedef char  TEXT;
    #define ASM
    #define REG(x)
    #define __inline
#endif

#include <exec/types.h>
#include <exec/memory.h>
#include <dos/dos.h>
#include <intuition/intuition.h>
#define ALL_REACTION_CLASSES
#define ALL_REACTION_MACROS
#include <reaction/reaction.h>

#include <proto/dos.h>
#include <proto/exec.h>
#include <proto/graphics.h>
#include <proto/intuition.h>
#include <proto/texteditor.h>
#include <proto/virtual.h>
#include <clib/alib_protos.h>

#include <gadgets/texteditor.h>              // do not rearrange!
#include <gadgets/virtual.h>

#include <ctype.h>
#include <stdio.h>                           /* FILE, printf() */
#include <stdlib.h>                          /* EXIT_SUCCESS, EXIT_FAILURE */
#include <string.h>
#include <assert.h>

#ifdef __SASC
    #include <dos.h>                         // geta4()
    #include <pragmas/texteditor_pragmas.h>
#endif

#include "mce.h"

// 2. DEFINES ------------------------------------------------------------

// main window
#define GID_PIR_LY1       0 // root layout
#define GID_PIR_SB1       1 // toolbar
#define GID_PIR_IN1       2 // crew
#define GID_PIR_IN2       3 // party gold
#define GID_PIR_IN3       4 // food
#define GID_PIR_IN4       5 // goods
#define GID_PIR_IN5       6 // sugar
#define GID_PIR_IN6       7 // cannon
#define GID_PIR_IN7       8 // ships
#define GID_PIR_IN8       9 // personal gold
#define GID_PIR_IN9      10 // day
#define GID_PIR_IN10     11 // year
#define GID_PIR_IN11     12 // land
#define GID_PIR_IN12     13 // rescued family members
#define GID_PIR_BU1      14 // maximize
#define GID_PIR_BU2      15 // cities...
#define GID_PIR_BU3      16 // location...
#define GID_PIR_ST1      17 // name
#define GID_PIR_ST2      18 // era
#define GID_PIR_VI1      19
#define GID_PIR_TE1      20 // description
#define GID_PIR_CH1      21 // month
#define GID_PIR_CH2      22 // difficulty
#define GID_PIR_CH3      23 // 1st ship
#define GID_PIR_CH4      24
#define GID_PIR_CH5      25
#define GID_PIR_CH6      26
#define GID_PIR_CH7      27
#define GID_PIR_CH8      28
#define GID_PIR_CH9      29
#define GID_PIR_CH10     30 // 8th ship
#define GID_PIR_CH11     31 // Spanish title
#define GID_PIR_CH12     32 // English title
#define GID_PIR_CH13     33 // French  title
#define GID_PIR_CH14     34 // Dutch   title
#define GID_PIR_LB1      35 // reposition
#define GID_PIR_CB1      36 //  1st map piece
#define GID_PIR_CB2      37 //  2nd map piece
#define GID_PIR_CB3      38 //  3rd map piece
#define GID_PIR_CB4      39 //  4th map piece
#define GID_PIR_CB5      40 //  5th map piece
#define GID_PIR_CB6      41 //  6th map piece
#define GID_PIR_CB7      42 //  7th map piece
#define GID_PIR_CB8      43 //  8th map piece
#define GID_PIR_CB9      44 //  9th map piece
#define GID_PIR_CB10     45 // 10th map piece
#define GID_PIR_CB11     46 // 11th map piece
#define GID_PIR_CB12     47 // 12th map piece
#define GID_PIR_SP1      48 // map
#define GID_PIR_CH_GAME  49

// location subwindow
#define GID_PIR_LY4      50 // root layout
#define GID_PIR_LB2      51

// cities subwindows
#define GID_PIR_LY2      52 // root layout
#define GID_PIR_LY3      53 //  1st city
#define GID_PIR_CH15    131 //  1st nationality
#define GID_PIR_ST3     209 //  1st city name
#define GID_PIR_IN13    287 //  1st soldiers
#define GID_PIR_IN91    365 //  1st citizens
#define GID_PIR_IN169   443 //  1st forts
#define GID_PIR_IN247   521 //  1st city gold
#define GID_PIR_IN324   598 // 78th city gold
#define GIDS_PIR        GID_PIR_IN324

#define AddCity(x)    ((x < cities[eracode]) ? (LAYOUT_AddChild) : TAG_IGNORE), gadgets[GID_PIR_LY3 + x] // don't put parentheses around this!

#define MAPWIDTH      160
#define MAPHEIGHT     201
#define MAPSCALEX       2
#define MAPSCALEY       1
#define SCALEDWIDTH    (MAPWIDTH  * MAPSCALEX)
#define SCALEDHEIGHT   (MAPHEIGHT * MAPSCALEY)

#define PIRATES1        0 // Pirates! (1990)
#define PIRATES2        1 // Pirates! Gold (1994)

// 3. MODULE FUNCTIONS ---------------------------------------------------

MODULE void readgadgets(void);
MODULE void writegadgets(void);
MODULE void serialize(void);
MODULE void maximize_man(void);
MODULE void eithergadgets(void);
MODULE void days2vars(void);
MODULE void vars2days(void);
MODULE void citieswindow(void);
MODULE void make_cities(void);
MODULE void drawpoint(int x, int y, int colour);
MODULE void locationwindow(void);
MODULE void pir_to_ami(STRPTR text);
MODULE void ami_to_pir(STRPTR text);
MODULE void remake_cities(void);

/* 4. EXPORTED VARIABLES -------------------------------------------------

(none)

5. IMPORTED VARIABLES ------------------------------------------------- */

IMPORT FLAG                 morphos;
IMPORT int                  function,
                            gadmode,
                            loaded,
                            page,
                            serializemode,
                            stringextra;
IMPORT LONG                 gamesize,
                            pens[PENS];
IMPORT TEXT                 pathname[MAX_PATH + 1];
IMPORT LONG                 gamesize;
IMPORT ULONG                offset,
                            showtoolbar;
IMPORT UBYTE                IOBuffer[IOBUFFERSIZE];
IMPORT struct HintInfo*     HintInfoPtr;
IMPORT struct Hook          ToolHookStruct,
                            ToolSubHookStruct;
IMPORT struct IBox          winbox[FUNCTIONS + 1];
IMPORT struct List          SpeedBarList;
IMPORT struct Menu*         MenuPtr;
IMPORT struct DiskObject*   IconifiedIcon;
IMPORT struct MsgPtr*       AppPort;
IMPORT struct Gadget*       gadgets[GIDS_MAX + 1];
IMPORT struct DrawInfo*     DrawInfoPtr;
IMPORT struct Library*      TextFieldBase;
IMPORT struct Image        *aissimage[AISSIMAGES],
                           *image[BITMAPS];
IMPORT struct Screen       *CustomScreenPtr,
                           *ScreenPtr;
IMPORT struct Window       *MainWindowPtr,
                           *SubWindowPtr;
IMPORT Object              *WinObject,
                           *SubWinObject;
IMPORT struct RastPort      wpa8rastport[2];
IMPORT UBYTE*               byteptr1[DISPLAY1HEIGHT];
IMPORT __aligned UBYTE      display1[DISPLAY1SIZE];

// function pointers
IMPORT FLAG (* tool_open)      (FLAG loadas);
IMPORT void (* tool_save)      (FLAG saveas);
IMPORT void (* tool_close)     (void);
IMPORT void (* tool_loop)      (ULONG gid, ULONG code);
IMPORT void (* tool_exit)      (void);
IMPORT FLAG (* tool_subgadget) (ULONG gid, UWORD code);

// 6. MODULE VARIABLES ---------------------------------------------------

MODULE TEXT                 cityname[39][15 + 1],
                            desc[150 + 1],
                            name[12 + 1]; // 11+1 for Pirates!, 12+1 for Pirates! Gold
MODULE ULONG                cannon,
                            citizens[39],
                            citygold[39],
                            city_x[39],
                            city_y[39],
                            crew,
                            day,
                            desclength,
                            difficulty,
                            elapseddays,
                            era,
                            eracode,
                            food,
                            forts[39],
                            game,
                            goods,
                            land,
                            location,
                            mapfound[12],
                            map_x[3],
                            map_y[3],
                            month,
                            nationality[39],
                            partygold,
                            personalgold,
                            repositioning,
                            rescued,
                            title[4],
                            ship[8],
                            ships,
                            skipamount,
                            soldiers[39],
                            sugar,
                            year;
MODULE int                  startoffset,
                            submode;
MODULE struct List          CountryList,
                            LocationsList,
                            RepositionList;

MODULE const STRPTR CountryOptions[4] =
{  "Spanish",
   "English",
   "French",
   "Dutch",
// "Pirate"
// no NULL is required
}, DifficultyOptions[4 + 1] =
{  "Apprentice",
   "Journeyman",
   "Adventurer",
   "Swashbuckler",
   NULL            // 4
}, EraOptions[7] =
{  "1560", // (The Silver Empire)
   "1580",
   "1600", // (Merchants and Smugglers)
   "1620", // (The New Colonists)
   "1640", // (War for Profit)
   "1660", // (The Buccaneer Heroes)
   "1680", // (Pirates' Sunset)
// no NULL is required
}, MonthOptions[12 + 1] =
{  "January",
   "February",
   "March",
   "April",
   "May",
   "June",
   "July",
   "August",
   "September",
   "October",
   "November",
   "December",
   NULL            // 12
}, ShipOptions[18 + 1] =
{  "Pinnace",                // $00
   "Sloop",                  // $01
   "Barque",                 // $02
   "Cargo fluyt",            // $03
   "Merchantman",            // $04
   "Frigate",                // $05
   "War galleon",            // $06
   "Galleon",                // $07
   "Fast galleon",           // $08
   "Pinnace (damaged)",      // $10
   "Sloop (damaged)",        // $11
   "Barque (damaged)",       // $12
   "Cargo fluyt (damaged)",  // $13
   "Merchantman (damaged)",  // $14
   "Frigate (damaged)",      // $15
   "War galleon (damaged)",  // $16
   "Galleon (damaged)",      // $17
   "Fast galleon (damaged)", // $18
   NULL
}, TitleOptions[10 + 1] =
{  "None",         //  0
   "Ensign",
   "Captain",
   "Major",
   "Colonel",
   "Admiral",      //  5
   "Baron",
   "Count",
   "Marquis",
   "Duke",         //  9
   NULL            // 10
}, GameOptions[2 + 1] =
{  "Pirates!",
   "Pirates! Gold",
   NULL
}, CityOptions[39][7] = {
// 1560              1580               1600               1620              1640                1660               1680
{ "Borburata"      , "Borburata"      , "Campeche"       , "Barbados"       , "Antigua"        , "Antigua"        , "Antigua"        },
{ "Campeche"       , "Campeche"       , "Caracas"        , "Campeche"       , "Barbados"       , "Barbados"       , "Barbados"       },
{ "Cartagena"      , "Cartagena"      , "Cartagena"      , "Caracas"        , "Bermuda"        , "Bermuda"        , "Belize"         },
{ "Coro"           , "Coro"           , "Coro"           , "Cartagena"      , "Campeche"       , "Campeche"       , "Bermuda"        },
{ "Cumana"         , "Cumana"         , "Cumana"         , "Coro"           , "Caracas"        , "Caracas"        , "Campeche"       },
{ "Eleuthera"      , "Eleuthera"      , "Eleuthera"      , "Cumana"         , "Cartagena"      , "Cartagena"      , "Caracas"        },
{ "Florida Keys"   , "Florida Keys"   , "Gibraltar"      , "Curacao"        , "Curacao"        , "Cumana"         , "Cartagena"      },
{ "Gibraltar"      , "Gibraltar"      , "Gran Granada"   , "Eleuthera"      , "Cumana"         , "Curacao"        , "Cumana"         },
{ "Gran Granada"   , "Gran Granada"   , "Grand Bahama"   , "Florida Keys"   , "Eleuthera"      , "Eleuthera"      , "Curacao"        },
{ "Grand Bahama"   , "Grand Bahama"   , "Grenada"        , "Gran Granada"   , "Florida Keys"   , "Gran Granada"   , "Eleuthera"      },
{ "Havana"         , "Havana"         , "Havana"         , "Grand Bahama"   , "Gran Granada"   , "Gibraltar"      , "Gran Granada"   },
{ "Isabella"       , "Isabella"       , "La Vega"        , "Gibraltar"      , "Guadeloupe"     , "Guadeloupe"     , "Guadeloupe"     },
{ "Maracaibo"      , "Maracaibo"      , "Maracaibo"      , "Havana"         , "Gibraltar"      , "Havana"         , "Leogane"        },
{ "Margarita"      , "Margarita"      , "Margarita"      , "La Vega"        , "Havana"         , "Leogane"        , "Havana"         },
{ "Nassau"         , "Nassau"         , "Panama"         , "Maracaibo"      , "La Vega"        , "Maracaibo"      , "Maracaibo"      },
{ "Nombre de Dios" , "Nombre de Dios" , "Puerto Bello"   , "Margarita"      , "Maracaibo"      , "Margarita"      , "Margarita"      },
{ "Panama"         , "Panama"         , "Puerto Cabello" , "Nevis"          , "Margarita"      , "Martinique"     , "Martinique"     },
{ "Puerto Cabello" , "Puerto Cabello" , "Puerto Principe", "Panama"         , "Martinique"     , "Montserrat"     , "Montserrat"     },
{ "Puerto Principe", "Puerto Principe", "Rio de la Hacha", "Petit-Goave"    , "Montserrat"     , "Nevis"          , "Nassau"         },
{ "Rio de la Hacha", "Rio de la Hacha", "San Juan"       , "Providence"     , "Nevis"          , "Panama"         , "Nevis"          },
{ "San Juan"       , "San Juan"       , "Santa Marta"    , "Puerto Bello"   , "Panama"         , "Petit-Goave"    , "Panama"         },
{ "Santo Domingo"  , "Santo Domingo"  , "Santiago"       , "Puerto Cabello" , "Petit-Goave"    , "Port-de-Paix"   , "Petit-Goave"    },
{ "Santiago"       , "Santiago"       , "Santiago Vega"  , "Puerto Principe", "Puerto Bello"   , "Port Royale"    , "Port-de-Paix"   },
{ "Santiago Vega"  , "Santiago Vega"  , "Santo Domingo"  , "Rio de la Hacha", "Puerto Principe", "Puerto Bello"   , "Port Royale"    },
{ "Santa Marta"    , "Santa Marta"    , "St. Augustine"  , "San Juan"       , "Rio de la Hacha", "Puerto Principe", "Puerto Bello"   },
{ "St. Augustine"  , "St. Augustine"  , "St. Lucia"      , "Santo Domingo"  , "San Juan"       , "Rio de la Hacha", "Puerto Principe"},
{ "Trinidad"       , "Trinidad"       , "St. Thome"      , "Santa Marta"    , "Santa Catalina" , "San Juan"       , "Rio de la Hacha"},
{ "Vera Cruz"      , "Vera Cruz"      , "Trinidad"       , "Santiago"       , "Santa Marta"    , "Santa Catalina" , "San Juan"       },
{ "Villa Hermosa"  , "Villa Hermosa"  , "Vera Cruz"      , "Santiago Vega"  , "Santiago"       , "Santa Marta"    , "Santa Marta"    },
{ "Yaguana"        , "Yaguana"        , "Villa Hermosa"  , "St. Augustine"  , "Santiago Vega"  , "Santiago"       , "Santiago"       },
{ "City #30"       , "City #30"       , "City #30"       , "St. Christophe" , "Santo Domingo"  , "Santo Domingo"  , "Santo Domingo"  },
{ "City #31"       , "City #31"       , "City #31"       , "St. Thome"      , "St. Augustine"  , "St. Augustine"  , "St. Augustine"  },
{ "City #32"       , "City #32"       , "City #32"       , "Tortuga"        , "St. Eustatius"  , "St. Eustatius"  , "St. Eustatius"  },
{ "City #33"       , "City #33"       , "City #33"       , "Trinidad"       , "St. Kitts"      , "St. Kitts"      , "St. Kitts"      },
{ "City #34"       , "City #34"       , "City #34"       , "Vera Cruz"      , "St. Martin"     , "St. Martin"     , "St. Martin"     },
{ "City #35"       , "City #35"       , "City #35"       , "Villa Hermosa"  , "Tortuga"        , "Tortuga"        , "Tortuga"        },
{ "City #36"       , "City #36"       , "City #36"       , "City #36"       , "Trinidad"       , "Trinidad"       , "Trinidad"       },
{ "City #37"       , "City #37"       , "City #37"       , "City #37"       , "Vera Cruz"      , "Vera Cruz"      , "Vera Cruz"      },
{ "City #38"       , "City #38"       , "City #38"       , "City #38"       , "Villa Hermosa"  , "Villa Hermosa"  , "Villa Hermosa"  },
};

MODULE const int cities[7] =
{ 30, // 1560
  30, // 1580
  30, // 1600
  36, // 1620
  39, // 1640
  39, // 1660
  39  // 1680
}, days[12] =
{ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 };

MODULE const STRPTR pir_map[MAPHEIGHT] = {
"------------==-------------------=------=------------------------=..............................................................................................",
"-----------=..=--==----=--------=.===!==.==-====------=---------=..................................................................!............................",
"-----------=.=--=..==-=.=--------=-=.......=....=----=.=---------=................................................................!*=...........................",
"------------==-=.....=-=.=---------!.............=--=..=--------=...............................................................................................",
"-----------=..=.......=...=-------!.............=--=....=--------*..............................................................................................",
"-----------=...............=------=..............==......=--------=.............................................................................................",
"----------=...............!.=------=......................=------=..............................................................................................",
"----------=..............=-=-!-!=---=.....................=-------=.............................................................................................",
"-----==--=................=.!.=..=---=...................=-------=..............................................................................................",
"-----==-=.........................=-=.....................=------=..............................................................................................",
"----=-==.........................=-=.......................=------=.............................................................................................",
"----=-=...........................=.......................=-------=.............................................................................................",
"----==.....................................................=-------=............................................................................................",
"---=-=......................................................=-----=.............................................................................................",
"---==.......................................................=------=............................................................................................",
"----=......................................................=-------=............................................................................................",
"--==.......................................................=-------=............................................................................................",
"--=.......................................................=---------=...........................................................................................",
"--=......................................................=---------=............................................................................................",
"--=.......................................................=---------=...........................................................................................",
"--=......................................................=--=------=............................................................................................",
"-=.......................................................=-=.=------=...........................................................................................",
"-=!.......................................................=..=------=...........................................................................................",
"-=!.........................................................=-------=...........................................................................................",
"--=........................................................=---------=..........................................................................................",
"--=.........................................................=-------=...........................................................................................",
"--=.........................................................=-------=...........................................................................................",
"-=.........................................................=---------=..........................................................................................",
"-=!.........................................................=-------=...........................................................................................",
"--=..........................................................=-------=.......!!!................................................................................",
"---=..........................................................=------=......!=-!=...............................................................................",
"--=..........................................................=--------=.......==-=..............................................................................",
"-=!.........................................................=-----=---=...!=.====-=.............................................................................",
"-=...........................................................=----=--=....=-!---!--=............................................................................",
"--=..........................................................=--------=....=*==!.!-=............................................................................",
"--=..........................................................=-------=..........!!-=............................................................................",
"--=...........................................................=-------=.........!=-=............................................................................",
"-=!...........................................................=------=..........!--=............................................................................",
"-=!............................................................=-----=..........=-!.............................................................................",
"--=.............................................................=----=....!!....=-=.............................................................................",
"---=............................................................=----=....!.!!.=.=..............................................................................",
"--=.............................................................=-----=...!..!!-=...............................................................................",
"-=...............................................................=---=...=-!..!!!...!...........................................................................",
"-=...............................................................=---=....=!.!!!!..!-=..........................................................................",
"--=..............................................................=----=..=-!.!!=-=.!-=..........................................................................",
"-=..............................................................!---!!....!...!.=..!!-=.........................................................................",
"-=..............................................................!=!!!-=...!.!!!..=.!=-=.........................................................................",
"--=.............................................................!!!!==.......!=.=-=!!-=.........................................................................",
"--=...........................................................!!!!!!-!....!..!-=.*!.=-=.........................................................................",
"--=.......................................................!...!-!!!!=......!.!-=..!=--==........................................................................",
"--=!......................................................!!!!!!!*!-!.....!!.=--=.!.=*=-=.......................................................................",
"--=!!.....................................................!!-!=-=..=......!.=---!..!..=-=.......................................................................",
"-=!......................................................!-!!!!!...........!!---!.!!..=-=.......................................................................",
"-=........................................................!...............!.!!--=.!-!..!-=......................................................................",
"-=.........................................................................!.!!-=.!!-!.=-=......................................................................",
"-=........................................................................!!.!.!-=.!!..=-=......................................................................",
"--=..................................................................!.....!!.!-=..!-!..==......................................................................",
"--=.................................................................!!....!!.!!!-=..!!..=-=.-...................................................................",
"--=.................................................................!.!....!..!!-=.!!-!.==.=....................................................................",
"--=..................................................................!.!...!.!.!=...!!!=-==-=...................................................................",
"--=....................................................................!....!.!.!..!!!-==-==....................................................................",
"-=......................................................................!..!!..!!...!.=-!-=.....................................................................",
"-=.................................................................!!......!!...!!!!!.!==-=.....................................................................",
"--=..........................................................=.==!!!-=.....!.!..!..!.!..!-!..!!!................................................................",
"-=.......................................................=..*-=---!!!-!......!..!!.!!!.!.=-!..!-!...............................................................",
"-=.....................................................==-==--------=!........!!.!!!..!.!!-!..!!................................................................",
"--=...................................................=---------------!......!!.!!..!.!!.=-=.=..................................................................",
"--=..................................................=-----------------=.=....!!.!!..!!...=.=-!.................................................................",
"--=.................................................=-----!!!!!---------=-=....!!..!=-=.....!--=!...............................................................",
"--=....................!............................=-----!.!=!---------==!==...!!!!.!.!....!!-=..=.............................................................",
"-=.................................................=-----!..=------------==--=.....!!.!-!...!!-=.=-=............................................................",
"--=..................!.............................!-----=.!.=------------===-=.....!!!!....=-!...=!............................................................",
"--=................................................!--!=!!....!=------------==-=.....!!-!!...=..................................................................",
"--=...............................................!=--==..!....!==-----------==-=.....!!.!..!.........=.........................................................",
"-=...............................................=---==-!.=.!!.!!.==---------==-!!.....!............==-=........................................................",
"--=................................==...=.........==-=.=.=-=....!...=---------==!-!................=-!-!........................................................",
"--=..............................==--===-=..........=...=---=.!......=---------=!!!.................!!!-!.......................................................",
"--=..........................=..=------=-=...............=--=.-.!.....!---------=--=.................!!!-==.....................................................",
"-=..........................=-==----------!.............=--=!!........!=!!!-----=!-=.............-...!!.!=-=....................................................",
"-=..................!.......=-------------!..............==...............!!--*--=-!..............=...!!..!.....................................................",
"--=........................=-------------=.............................!!..!-------!!............=-=...!..!.....................................................",
"-=........................=---------------=............................!=!.!---------!=.........=!-=........!...................................................",
"-=.........................=-------------=.............................=-=!!-----------!.......!---=.......!...!................................................",
"-=.........................=------------=...............................=-!!!-----------!......!--!............!................................................",
"--=........................=-------------=...............................=-!!!---------=........=!..............!...............................................",
"---=......................=-------------=.=..............................=-=.!---------=.=......................!...............................................",
"--=........................=------------==-=..............................=-!!!!!-------=-!!...................!................................................",
"--==.......................=-----------==-=................................=-!.!!-----------=...................!...............................................",
"----=......................=----------=..=..................................=...!=----------=..................!................................................",
"----=.....................=-----------=........................................!.!-----------=..................................................................",
"---=......................*------------=.......................................!!-------------!...==............................................................",
"---=.....................=-------------=.......................................!------*------=...=-*=...........................................................",
"----*....................=------------=.......................................=-----==.=-=-==.....=.=...==......................................................",
"-----=....................=-----------=..............................=........=---==....=.=......==*-!!=--=*....................................................",
"------=..................=-------------=............................=-!-.......===..............=-----------===.................................................",
"-----=...................=-------------=.............................=...........................==------------=................................................",
"------=.................=-------------=.........................==.................................=------------==..............................................",
"-------=...............=---------------!.......................=--=.................................=-------------!.............................................",
"--------=............=.=--------------=........................!!=!.................................=-----------==....................=.!!!.....................",
"--------=.......===.=-==---------------=...........................................................=-------------!=.=................=-=!!-!....................",
"---------=....==---=.=.=------------=--=............................................................=--------------=-=................!!!.!.....................",
"----------=..=------=.=------------==-=..............................................................=----------------=..............=..........................",
"----------=.=--------=-------------==-=!..............................................................=---------------!....====...=.=-!......=..................",
"-----------=-----------------------==-=!.....................................................=.......=*---------------!...=----*==-=-=......=-!!................",
"-----------------*----------------=.=-=.....................................................=-==....*----------*=-----=...=------===!......=-=..................",
"-----------------------------------=.!.......................................==!===.........=---=...=------=--=..!==-=....=------==-=.......=...=...............",
"------------------------------------=-=.....................................!------=........=----==*------=.=-=.....=...=.=-----==-=.......=*..=-!..............",
"------------------------------------=-=....................................=-------==........=-------------!.=.....=-=.=-=-----=..=..=..........!...............",
"------------------------------------==......................................==-------=........=-===---==---=........=...=.=====.....=-=.........................",
"-----------------------------------=.........................................=--------=.......=--=.===.=---=.......................=-!.......*..................",
"----------------------------------=..=........................................=----*--!........==.......=-=.........................!...........................",
"----------------------------------*.!-=.......................................=---=.=-!.................=-=.................................*....=..............",
"-----------------------------------=.!=.......................................!===...=...................=......................................=-=.............",
"----------------------------------=..=-=.!....................................................................................................*..*..............",
"-----------------------------------=..!!.!...........!..........................................................................................................",
"----------------------------------=...!-!.!.........!-..........................................................................................................",
"----------------------------------=..!.!.!..........!!.........................................................................................*................",
"----------------------------------=..!.!..!........................................................................................................=............",
"-----------------------------------=..............................................................................................................=-=...........",
"------==--------=------------------!.!.!.!!......................................................................................................=--=...........",
"=---==..==------==----------------=.!.!.!!....................................!!.................................................................=-!-=..........",
".===......=------==--------------=..!!.!...!..................................!!..................................................................*==...........",
"...........=------=---------------=!...!!!!-!-.....................................................................................................=-=..........",
"...........=---------------------=.!.!...=-=.!.....................................................................................................=-=..........",
"............=-------------------=...!.!!..!.........................................................................................................=...........",
".............=-----------------=..=..!.................!...........................................................................................==...........",
"..............=-----------------==-==..!.!...=..=......!!.........................................................................................=--=..........",
"..............=----------------=.=-=-=.=.!===-==-=...!..!.........................................................................................=--=..........",
"...............=----------------=--=--=-=------=--==.....!.!..........!!...........................................................................=-=..........",
"................=-----------------------------------=....!............!!............................................................................=...........",
"................=------------------------------------=..........................................................................................................",
"................=-----------------------------------=.=.!............................................................................................=..........",
".................=---------------------------------=.=..............................................................................................=-=.........",
".................=----------------------------------=.=..!..........................................................................................=-=.........",
"..................=----------------------------------=-=..!!.........................................................................................*-=........",
".................=--------------------------------------=..!........................................................................................=--=........",
"..................=------------------------------------=..!!.........................................................................................==.........",
"..................=-----------------------------------=...!...........................................................................................=.........",
"...................=----------------------------------=...!..........................................................................................*-=........",
"....................==---------------------------------=..!.........................................................................................=--=........",
"......................==--------------------------------!!!.....!...!...............................................................................=-=.........",
".......................=--------------------------------!-!.....!...!!...............................................................................=..........",
"........................=------------------------------=.=!.....!...!...........................................................................................",
".........................=----------------------------=............!.................................................................................=......=...",
"..........................=----------------------------=............................................................................................=-=....=-!..",
"...........................=--------------------------=.............................................................................................=-=....=--=.",
"............................=-------------------------=.............................................................................................=-=.....*-=.",
".............................=--=----------------------=.............................................................................................=.......=..",
"..............................==.=--=-----------------=..............................................................................................!..........",
"..................................==--=--------------=...!.....!.....!..........................................................................................",
".....................................=----------------=.!......*....................................................................................!!..........",
".....................................==--------------=..!.......!..................................................................................=-=!!........",
"....................................=-=---------------!.............................................................................................!..!........",
"....................................=----------------=.!...........................................................................................!!.!.........",
".....................................=---------------=.!...........................................................................................=-=!.........",
".....................................=----------------=.........................................................==................................!.=.!.........",
"......................................=---------------!........................................................=--=.................................=...........",
".......................................=-==-----------!.......!..........................................=......==..=..............................=*!..........",
"........................................=-=----------=.!.....=-=........................................=-=........=-=.=........................................",
"........................................=------------=.!=.....!!........................................=--=....==..*-!-=.......................................",
".........................................=--*---------==-=...............................................=--=..=--=..=!=..!...!!........=...........!...........",
"........................................=---!--------=..=.....!........................................==--=..=---=...........!!.!.....!-=..........!...........",
".........................................=--!!-------=................................................=---=...=---=.....................!.......!...............",
"..........................................=-=.=-----=................................................=----=...=---=............................-!!......==......",
"..........................................=-!.!------=...............................................=--==.....=-=.............................!.......=--=.....",
"..........................................=--!.!------=.............................................=---=.......=*.=.......................=............==......",
"..........................................=--!.=-----=.............................................*---==.......=-=-==...................==-=..........=........",
"...........................................=-=.!!---=.............................................-------=....==------=.................!--*......=..==-=.......",
"............................................=-=.!----=........................................*----------=...=---------=...........!.!...=!.....==-==---=.......",
"............................................=-!!!---=.........................................=---------=...=-----------!...........-....!=!==.=---==---=.......",
"............................................=---!----=.......................................=----------=..=------------=...............=-----=--==.=---=.......",
"...........................................=--------=.......................................==----------=..=------------!................=!-----=....=--=.......",
"............................................=--------=.....................................=-=----------=.=-------------=.....=.=........*-----=...=.*--=.......",
".............................................=--------=....................................=-=----------=..=------------=.=..*-=-==......=------=.=-==-=........",
"............................................=--------=....................................=--------------*.=-------------*-==------=....=--------=.=..=.........",
".............................................=--------=..................................=---------------=.=------------------------=.==---------==-==..........",
"............................................=----------=................................=----------------=.=--------------!----------=--------------=-=.........",
"...........................................=-----------=................................=---------------=..=--------------=---------------------------==........",
"............................................=--=------==.................................*--------------=...=-------------------------------------------=.......",
"............................................=--=--------=...............................==--------------=...=--------------------------------------------=......",
".............................................=-==-------=..............................=..=------------=....=--------------------------------------------=......",
".............................................=--=--------=..............................===-------------=..=--------------------------------------------=.......",
"..............................................=-=--------=...............................=--------------=...*--------------------------------------------=......",
"...............................................==--------=.............=.................=-------------=...=--------------------------------------------=.......",
".................................................==-------=...........*-*=!!............=--------------==...=--------------------------------------------=.==...",
"...................................................=-------==........!----!!............=----------------=..=--------------------------------------------==--=..",
"....................................................=-----==-=.......!!-----==.........==----------------=..=------------------------------------------------=..",
"....................................................=------=!.......=-!-------=.......=-=---------------=..=--------------------------------------*-----------=.",
".....................................................=-----=.=.....=-------==-=.......=------------------==---------------------------------------------------=.",
".....................................................=----=-=-=...=----*---==--=.....=-------------------------------------------------------------------------=",
".....................................................==--------=..=----!==--=--=....=--------------------------------------------------------------------------=",
"....................................................=----------=.=----=...=-----=..=----------------------------------------------------------------------------",
"....................................................=--=--------=-----=...=------=..=---------------------------------------------------------------------------",
"....................................................=--=---------------=...=-----=.=----------------------------------------------------------------------------",
".....................................................===--------------=....=-----=..=---------------------------------------------------------------------------",
".......................................................=-------------=.....=------==----------------------------------------------------------------------------",
".......................................................=-===-------==.......=-----=.=---------------------------------------------------------------------------",
".......................................................=-=..==-----=.......=------=.=---------------------------------------------------------------------------",
"........................................................=....=------=......=-------=----------------------------------------------------------------------------",
".............................................................=------=......=------------------------------------------------------------------------------------",
".............................................................=------=......=------------------------------------------------------------------------------------",
};

// 7. MODULE STRUCTURES --------------------------------------------------

MODULE struct ColumnInfo RepositionColumnInfo[] =
{ { 0,                            // WORD   ci_Width
    "",                           // STRPTR ci_Title
    CIF_FIXED | CIF_NOSEPARATORS  // ULONG  ci_Flags
  },
  { 100,
    "",
    0 /* Last column must not have CIF_DRAGGABLE set (CIF_DRAGGABLE
         applies to the right border of the relevant column). */
  },
  { -1, (STRPTR) ~0, -1
} }, LocationColumnInfo[] =
{ { 0,                            // WORD   ci_Width
    "",                           // STRPTR ci_Title
    CIF_FIXED | CIF_NOSEPARATORS  // ULONG  ci_Flags
    // CIF_NOSEPARATORS is having no effect, under OS3.9 at least
  },
  { 100,
    "",
    0 /* Last column must not have CIF_DRAGGABLE set (CIF_DRAGGABLE
         applies to the right border of the relevant column). */
  },
  { -1, (STRPTR) ~0, -1
} };

// 8. CODE ---------------------------------------------------------------

EXPORT void pir_main(void)
{   PERSIST FLAG first = TRUE;

    if (first)
    {   first = FALSE;

        // pir_preinit()
        NewList(&CountryList);
        NewList(&LocationsList);
        NewList(&RepositionList);
    }

    tool_open      = pir_open;
    tool_loop      = pir_loop;
    tool_save      = pir_save;
    tool_close     = pir_close;
    tool_exit      = pir_exit;
    tool_subgadget = pir_subgadget;

    if (loaded != FUNC_PIRATES && !pir_open(TRUE))
    {   function = page = FUNC_MENU;
        return;
    } // implied else
    loaded = FUNC_PIRATES;

    ch_load_images(104, 107, CountryOptions, &CountryList);
    load_images(108, 108);
    load_images(217, 220);
    RepositionColumnInfo[0].ci_Width = image[104]->Width + 6;
    LocationColumnInfo[  0].ci_Width = image[104]->Width + 6;
    make_cities();
    make_speedbar_list(GID_PIR_SB1);
    load_aiss_images(10, 10);
    pir_getpens();

    InitHook(&ToolHookStruct, (ULONG (*)())ToolHookFunc, NULL);
    lockscreen();

    if (!(WinObject =
    NewToolWindow,
        WA_SizeGadget,                                         TRUE,
        WA_ThinSizeGadget,                                     TRUE,
        WINDOW_Position,                                       WPOS_CENTERMOUSE,
        WINDOW_ParentGroup,                                    gadgets[GID_PIR_LY1] = (struct Gadget*)
        VLayoutObject,
            LAYOUT_SpaceOuter,                                 TRUE,
            AddHLayout,
                AddToolbar(GID_PIR_SB1),
                AddSpace,
                AddVLayout,
                    AddSpace,
                    LAYOUT_AddChild,                           gadgets[GID_PIR_CH_GAME] = (struct Gadget*)
                    PopUpObject,
                        GA_ID,                                 GID_PIR_CH_GAME,
                        GA_Disabled,                           TRUE,
                        CHOOSER_LabelArray,                    &GameOptions,
                        CHOOSER_Selected,                      (WORD) game,
                    PopUpEnd,
                    Label("Game:"),
                    CHILD_WeightedHeight,                      0,
                    AddSpace,
                LayoutEnd,
                CHILD_WeightedWidth,                           0,
                AddSpace,
                AddVLayout,
                    AddSpace,
                    CHILD_WeightedHeight,                      50,
                    MaximizeButton(GID_PIR_BU1, "Maximize Game"),
                    CHILD_WeightedHeight,                      0,
                    AddSpace,
                    CHILD_WeightedHeight,                      50,
                LayoutEnd,
                CHILD_WeightedWidth,                           0,
                AddSpace,
            LayoutEnd,
            CHILD_WeightedHeight,                              0,
            AddHLayout,
                AddVLayout,
                    AddHLayout,
                        LAYOUT_VertAlignment,                  LALIGN_CENTER,
                        AddLabel("Description:"),
                        CHILD_WeightedWidth,                   0,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_TE1] = (struct Gadget*)
                        TextEditorObject,
                            GA_ID,                             GID_PIR_TE1,
                            GA_ReadOnly,                       morphos ? TRUE : FALSE,
                            GA_TEXTEDITOR_Contents,            desc,
                        TextEditorEnd,
                        CHILD_MinHeight,                       64,
                    LayoutEnd,
                    AddVLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Personal",
                        LAYOUT_AddChild,                       gadgets[GID_PIR_ST1] = (struct Gadget*)
                        StringObject,
                            GA_ID,                             GID_PIR_ST1,
                            GA_TabCycle,                       TRUE,
                            STRINGA_TextVal,                   name,
                            STRINGA_MaxChars,                  12 + 1,
                            STRINGA_MinVisible,                12 + stringextra,
                        StringEnd,
                        Label("Name:"),
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN8] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN8,
                                GA_TabCycle,                   TRUE,
                                INTEGER_Minimum,               0,
                                INTEGER_Maximum,               99999,
                                INTEGER_Number,                personalgold,
                                INTEGER_MinVisible,            5 + 1,
                            IntegerEnd,
                            AddLabel("0"),
                            CHILD_WeightedWidth,               0,
                        LayoutEnd,
                        Label("Gold (wealth):"),
                        CHILD_WeightedHeight,                  0,
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN11] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN11,
                                GA_TabCycle,                   TRUE,
                                INTEGER_Minimum,               0,
                                INTEGER_Maximum,               1310, // 1310*50=65500
                                INTEGER_Number,                land,
                                INTEGER_MinVisible,            4 + 1,
                            IntegerEnd,
                            AddLabel("*50 acres"),
                            CHILD_WeightedWidth,               0,
                        LayoutEnd,
                        Label("Land:"),
                        CHILD_WeightedHeight,                  0,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN12] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN12,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   0,
                            INTEGER_Maximum,                   4,
                            INTEGER_Number,                    rescued,
                        IntegerEnd,
                        Label("Rescued family members:"),
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH2] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH2,
                            CHOOSER_LabelArray,                DifficultyOptions,
                        PopUpEnd,
                        Label("Difficulty:"),
                        CHILD_WeightedHeight,                  0,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                    AddVLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Party",
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN1] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN1,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   1,
                            INTEGER_Maximum,                   700,
                            INTEGER_Number,                    crew,
                            INTEGER_MinVisible,                3 + 1,
                        IntegerEnd,
                        Label("Crew:"),
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN2] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN2,
                                GA_TabCycle,                   TRUE,
                                INTEGER_Minimum,               0,
                                INTEGER_Maximum,               99999,
                                INTEGER_Number,                partygold,
                                INTEGER_MinVisible,            5 + 1,
                            IntegerEnd,
                            AddLabel("0"),
                            CHILD_WeightedWidth,               0,
                        LayoutEnd,
                        Label("Gold:"),
                        CHILD_WeightedHeight,                  0,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN3] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN3,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   0,
                            INTEGER_Maximum,                   999,
                            INTEGER_Number,                    food,
                            INTEGER_MinVisible,                3 + 1,
                        IntegerEnd,
                        Label("Food:"),
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN4] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN4,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   0,
                            INTEGER_Maximum,                   999,
                            INTEGER_Number,                    goods,
                            INTEGER_MinVisible,                3 + 1,
                        IntegerEnd,
                        Label("Goods:"),
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN5] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN5,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   0,
                            INTEGER_Maximum,                   999,
                            INTEGER_Number,                    sugar,
                            INTEGER_MinVisible,                3 + 1,
                        IntegerEnd,
                        Label("Hides/Sugar/Tobacco:"),
                        LAYOUT_AddChild,                       gadgets[GID_PIR_IN6] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                             GID_PIR_IN6,
                            GA_TabCycle,                       TRUE,
                            INTEGER_Minimum,                   0,
                            INTEGER_Maximum,                   998,
                            INTEGER_Number,                    cannon,
                            INTEGER_MinVisible,                3 + 1,
                        IntegerEnd,
                        Label("Cannon:"),
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                LayoutEnd,
                AddVLayout,
                    AddVLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Ships",
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            AddLabel("Number of ships:"),
                            CHILD_WeightedWidth,               0,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN7] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN7,
                                GA_TabCycle,                   TRUE,
                                GA_RelVerify,                  TRUE,
                                INTEGER_Minimum,               1,
                                INTEGER_Maximum,               8,
                                INTEGER_Number,                ships,
                                INTEGER_MinVisible,            1 + 1,
                            IntegerEnd,
                        LayoutEnd,
                        CHILD_WeightedHeight,                  0,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH3] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH3,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH4] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH4,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH5] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH5,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH6] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH6,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH7] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH7,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH8] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH8,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH9] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH9,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                        LAYOUT_AddChild,                       gadgets[GID_PIR_CH10] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                             GID_PIR_CH10,
                            CHOOSER_LabelArray,                ShipOptions,
                            CHOOSER_MaxLabels,                 18,
                        PopUpEnd,
                    LayoutEnd,
                    AddHLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Titles",
                        AddVLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            AddImage(217),
                            AddImage(218),
                            AddImage(219),
                            AddImage(220),
                        LayoutEnd,
                        CHILD_WeightedWidth,                   0,
                        AddVLayout,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_CH11] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                         GID_PIR_CH11,
                                CHOOSER_LabelArray,            &TitleOptions,
                                CHOOSER_Selected,              (WORD) title[0],
                            PopUpEnd,
                            Label("Spanish:"),
                            LAYOUT_AddChild,                   gadgets[GID_PIR_CH12] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                         GID_PIR_CH12,
                                CHOOSER_LabelArray,            &TitleOptions,
                                CHOOSER_Selected,              (WORD) title[1],
                            PopUpEnd,
                            Label("English:"),
                            LAYOUT_AddChild,                   gadgets[GID_PIR_CH13] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                         GID_PIR_CH13,
                                CHOOSER_LabelArray,            &TitleOptions,
                                CHOOSER_Selected,              (WORD) title[2],
                            PopUpEnd,
                            Label("French:"),
                            LAYOUT_AddChild,                   gadgets[GID_PIR_CH14] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                         GID_PIR_CH14,
                                CHOOSER_LabelArray,            &TitleOptions,
                                CHOOSER_Selected,              (WORD) title[3],
                            PopUpEnd,
                            Label("Dutch:"),
                        LayoutEnd,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                    AddVLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "When & Where",
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            AddLabel("Era:"),
                            CHILD_WeightedWidth,               0,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_ST2] = (struct Gadget*)
                            StringObject,
                                GA_ID,                         GID_PIR_ST2,
                                GA_ReadOnly,                   TRUE,
                                STRINGA_TextVal,               EraOptions[eracode],
                            StringEnd,
                        LayoutEnd,
                        CHILD_WeightedHeight,                  0,
                        AddHLayout,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN9] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN9,
                                GA_TabCycle,                   TRUE,
                                INTEGER_Minimum,               1,
                                INTEGER_Maximum,               31,
                                INTEGER_Number,                day,
                                INTEGER_MinVisible,            2 + 1,
                            IntegerEnd,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_CH1] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                         GID_PIR_CH1,
                                CHOOSER_LabelArray,            MonthOptions,
                            PopUpEnd,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_IN10] = (struct Gadget*)
                            IntegerObject,
                                GA_ID,                         GID_PIR_IN10,
                                GA_TabCycle,                   TRUE,
                                INTEGER_Minimum,               era,
                                INTEGER_Maximum,               era + 90,
                                INTEGER_Number,                year,
                                INTEGER_MinVisible,            4 + 1,
                            IntegerEnd,
                        LayoutEnd,
                        CHILD_WeightedHeight,                  0,
                        AddHLayout,
                            LAYOUT_VertAlignment,              LALIGN_CENTER,
                            AddLabel("Location:"),
                            CHILD_WeightedWidth,               0,
                            LAYOUT_AddChild,                   gadgets[GID_PIR_BU3] = (struct Gadget*)
                            ZButtonObject,
                                GA_ID,                         GID_PIR_BU3,
                                GA_RelVerify,                  TRUE,
                                GA_Text,                       cityname[location],
                                BUTTON_Justification,          BCJ_LEFT,
                            ButtonEnd,
                        LayoutEnd,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                LayoutEnd,
            LayoutEnd,
            AddHLayout,
                AddHLayout,
                    LAYOUT_BevelStyle,                         BVS_GROUP,
                    LAYOUT_SpaceOuter,                         TRUE,
                    LAYOUT_Label,                              "Reposition",
                    LAYOUT_AddChild,                           gadgets[GID_PIR_LB1] = (struct Gadget*)
                    ListBrowserObject,
                        GA_ID,                                 GID_PIR_LB1,
                        GA_RelVerify,                          TRUE,
                        LISTBROWSER_ColumnInfo,                (ULONG) &RepositionColumnInfo,
                        LISTBROWSER_Labels,                    (ULONG) &RepositionList,
                        LISTBROWSER_ColumnTitles,              FALSE,
                        LISTBROWSER_MinVisible,                1,
                        LISTBROWSER_ShowSelected,              TRUE,
                        LISTBROWSER_AutoWheel,                 FALSE,
                    ListBrowserEnd,
                    CHILD_MinWidth,                            128,
                    LAYOUT_AddChild,                           gadgets[GID_PIR_SP1] = (struct Gadget*)
                    SpaceObject,
                        GA_ID,                                 GID_PIR_SP1,
                        SPACE_MinWidth,                        SCALEDWIDTH,
                        SPACE_MinHeight,                       SCALEDHEIGHT,
                        SPACE_BevelStyle,                      BVS_FIELD,
                        SPACE_Transparent,                     TRUE,
                    SpaceEnd,
                    CHILD_WeightedWidth,                       0,
                LayoutEnd,
                AddVLayout,
                    LAYOUT_BevelStyle,                         BVS_GROUP,
                    LAYOUT_SpaceOuter,                         TRUE,
                    LAYOUT_Label,                              "Quarters",
                    AddHLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Pirate",
                        AddVLayout,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB1] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB1,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB2] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB2,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB3] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB3,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB4] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB4,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                        LayoutEnd,
                        CHILD_WeightedWidth,                   0,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                    AddSpace,
                    AddHLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Family",
                        AddVLayout,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB5] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB5,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB6] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB6,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB7] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB7,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB8] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB8,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                        LayoutEnd,
                        CHILD_WeightedWidth,                   0,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                    AddSpace,
                    AddHLayout,
                        LAYOUT_BevelStyle,                     BVS_GROUP,
                        LAYOUT_SpaceOuter,                     TRUE,
                        LAYOUT_Label,                          "Inca",
                        AddVLayout,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB9] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB9,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB10] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB10,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                            AddHLayout,
                                AddSpace,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB11] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB11,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                LAYOUT_AddChild,               gadgets[GID_PIR_CB12] = (struct Gadget*)
                                TickOrCheckBoxObject,
                                    GA_ID,                     GID_PIR_CB12,
                                    GA_Text,                   "",
                                End,
                                CHILD_WeightedWidth,           0,
                                AddSpace,
                            LayoutEnd,
                        LayoutEnd,
                        CHILD_WeightedWidth,                   0,
                    LayoutEnd,
                    CHILD_WeightedHeight,                      0,
                LayoutEnd,
                CHILD_WeightedWidth,                           0,
            LayoutEnd,
            CHILD_WeightedHeight,                              0,
            LAYOUT_AddChild,                                   gadgets[GID_PIR_BU2] = (struct Gadget*)
            ZButtonObject,
                GA_ID,                                         GID_PIR_BU2,
                GA_RelVerify,                                  TRUE,
                GA_Text,                                       "Cities...",
            ButtonEnd,
            CHILD_WeightedHeight,                              0,
        LayoutEnd,
        CHILD_NominalSize,                                     TRUE,
    WindowEnd))
    {   rq("Can't create gadgets!");
    }
    unlockscreen();
    openwindow(GID_PIR_SB1);

    setup_bm(0, SCALEDWIDTH, SCALEDHEIGHT, MainWindowPtr);

    // pir_drawmap();
    SetGadgetAttrs(                     gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Labels,              ~0,              TAG_END);
    SetGadgetAttrs(                     gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Labels,              &RepositionList, TAG_END);
    if (game == PIRATES1)
    {   SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Selected,    (ULONG) repositioning,   TAG_END);
        RefreshGadgets((struct Gadget*) gadgets[GID_PIR_LB1], MainWindowPtr, NULL);
        SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_MakeVisible, (ULONG) repositioning,   TAG_END);
    } else
    {   SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Selected,    (ULONG) ~0,              TAG_END);
    }
    RefreshGadgets(    (struct Gadget*) gadgets[GID_PIR_LB1], MainWindowPtr, NULL);

    writegadgets();
    DISCARD ActivateLayoutGadget(gadgets[GID_PIR_LY1], MainWindowPtr, NULL, (Object) gadgets[GID_PIR_ST1]);
    loop();
    readgadgets();
    closewindow();
}

EXPORT void pir_loop(ULONG gid, UNUSED ULONG code)
{   int i;

    switch (gid)
    {
    case GID_PIR_BU1:
        readgadgets();
        maximize_man();
        writegadgets();
    acase GID_PIR_BU2:
        citieswindow();
    acase GID_PIR_BU3:
        locationwindow();
    acase GID_PIR_IN7:
        DISCARD GetAttr(INTEGER_Number, (Object*) gadgets[GID_PIR_IN7], (ULONG*) &ships);
        for (i = 0; i < 8; i++)
        {   DISCARD SetGadgetAttrs
            (   gadgets[GID_PIR_CH3 + i], MainWindowPtr, NULL,
                GA_Disabled, i >= (int) ships ? TRUE : FALSE,
            TAG_DONE); // this autorefreshes
        }
    acase GID_PIR_LB1:
        if (game == PIRATES1)
        {   DISCARD GetAttr(LISTBROWSER_Selected, (Object*) gadgets[GID_PIR_LB1], (ULONG*) &repositioning);
            pir_drawmap();
}   }   }

EXPORT FLAG pir_open(FLAG loadas)
{   if (gameopen(loadas))
    {   if (gamesize == 780)
        {   game = PIRATES2;
            startoffset = 0;
        } elif (gamesize == 848)
        {   game = PIRATES2;
            startoffset = 68;
        } else
        {   game = PIRATES1;
        }
        serializemode = SERIALIZE_READ;
        serialize();
        writegadgets();
        return TRUE;
    } // implied else
    return FALSE;
}

MODULE void writegadgets(void)
{   if
    (   page != FUNC_PIRATES
     || !MainWindowPtr
    )
    {   return;
    } // implied else

    gadmode = SERIALIZE_WRITE;
    eithergadgets();
    pir_drawmap();
}

MODULE void eithergadgets(void)
{   int    i;
    STRPTR stringptr /* = NULL */ ;

    either_st(GID_PIR_ST1,   name         );
    if (game == PIRATES1 && gadmode == SERIALIZE_READ && name[12] != EOS)
    {   name[12] = EOS;
        SetGadgetAttrs(gadgets[GID_PIR_ST1], MainWindowPtr, NULL, STRINGA_TextVal, name, TAG_END); // this autorefreshes
    }

    either_in(GID_PIR_IN1,   &crew        );
    either_in(GID_PIR_IN2,   &partygold   );
    either_in(GID_PIR_IN3,   &food        );
    either_in(GID_PIR_IN4,   &goods       );
    either_in(GID_PIR_IN5,   &sugar       );
    either_in(GID_PIR_IN6,   &cannon      );
    either_in(GID_PIR_IN7,   &ships       ); // this one is order-dependent!
    either_in(GID_PIR_IN8,   &personalgold);
    either_in(GID_PIR_IN11,  &land        );
    either_in(GID_PIR_IN12,  &rescued     );
    either_ch(GID_PIR_CH2,   &difficulty  );
    either_ch(GID_PIR_CH11,  &title[0]    );
    either_ch(GID_PIR_CH12,  &title[1]    );
    either_ch(GID_PIR_CH13,  &title[2]    );
    either_ch(GID_PIR_CH14,  &title[3]    );

    if (gadmode == SERIALIZE_READ)
    {   stringptr = (STRPTR) DoGadgetMethod
        (   gadgets[GID_PIR_TE1], MainWindowPtr, NULL,
            GM_TEXTEDITOR_ExportText, NULL
        );
        if (strlen(stringptr) > desclength)
        {   zstrncpy(desc, stringptr, desclength);
        } else
        {   strcpy(desc, stringptr);
        }
        FreeVec(stringptr);
        // stringptr = NULL;

        if (game == PIRATES1)
        {   DISCARD GetAttr(LISTBROWSER_Selected, (Object*) gadgets[GID_PIR_LB1], (ULONG*) &repositioning);
    }   }
    else
    {   // assert(gadmode == SERIALIZE_WRITE);

        SetGadgetAttrs(gadgets[GID_PIR_CH_GAME], MainWindowPtr, NULL, CHOOSER_Selected, (WORD) game, TAG_DONE); // autorefreshes

        SetGadgetAttrs(gadgets[GID_PIR_ST2], MainWindowPtr, NULL, STRINGA_TextVal, EraOptions[eracode], TAG_DONE); // autorefreshes

        SetGadgetAttrs(gadgets[GID_PIR_TE1], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, GA_TEXTEDITOR_Contents, desc, TAG_DONE);

        SetGadgetAttrs(gadgets[GID_PIR_IN9 ], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, TAG_DONE);
        SetGadgetAttrs(gadgets[GID_PIR_IN10], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, TAG_DONE);
        SetGadgetAttrs(gadgets[GID_PIR_IN12], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, TAG_DONE);
        SetGadgetAttrs(gadgets[GID_PIR_CH1 ], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, TAG_DONE);

        remake_cities();

        for (i = 0; i < 8; i++)
        {   DISCARD SetGadgetAttrs
            (   gadgets[GID_PIR_CH3 + i], MainWindowPtr, NULL,
                GA_Disabled, i >= (int) ships ? TRUE : FALSE,
            TAG_DONE); // this autorefreshes
        }

        DISCARD SetGadgetAttrs(         gadgets[GID_PIR_BU3], MainWindowPtr, NULL, GA_Text,                         cityname[location], TAG_END); // this refreshes automatically
    }

    either_ch(GID_PIR_CH1, &month);
    either_in(GID_PIR_IN9, &day);
    if ((int) day > days[month])
    {   day = days[month];
        DISCARD SetGadgetAttrs
        (   gadgets[GID_PIR_IN9], MainWindowPtr, NULL,
            INTEGER_Number, day,
        TAG_END); // this autorefreshes
    }
    DISCARD SetGadgetAttrs
    (   gadgets[GID_PIR_IN10], MainWindowPtr, NULL,
        INTEGER_Minimum, era,
        INTEGER_Maximum, era + 90,
    TAG_END); // this autorefreshes
    either_in(GID_PIR_IN10, &year);

    for (i = 0; i < 8; i++)
    {   either_ch(GID_PIR_CH3 + i, &ship[i]);
    }
    for (i = 0; i < 12; i++)
    {   either_cb(GID_PIR_CB1 + i, &mapfound[i]);
}   }

MODULE void days2vars(void)
{   int i,
        tempdays;

    tempdays = elapseddays;
    year = era + (tempdays / 365);
    tempdays %= 365;

    for (i = 0; i < 12; i++)
    {   if (tempdays < days[i])
        {   day = tempdays + 1;
            month = i;
            return;
        } else
        {   tempdays -= days[i];
    }   }

    // assert(0);
}

MODULE void vars2days(void)
{   int i;

    elapseddays = (year - era) * 365;
    if (month >= 1)
    {   for (i = 0; i < (int) month; i++)
        {   elapseddays += days[i];
    }   }
    elapseddays += day - 1;
}

MODULE void readgadgets(void)
{   gadmode = SERIALIZE_READ;
    eithergadgets();
}

MODULE void serialize(void)
{   int   i,
          thelength;
    TEXT  desc2[150 + 1];
    UBYTE t;

    switch (game)
    {
    case PIRATES1:
        offset = 5;
        serialize1(&desclength);
        if (serializemode == SERIALIZE_READ)
        {   zstrncpy(desc, (char*) &IOBuffer[offset], desclength);
            for (i = 0; i < (int) desclength; i++)
            {   if (desc[i] == CR)
                {   desc[i] = LF;
            }   }
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            strcpy(desc2, desc);
            for (i = 0; i < (int) desclength; i++)
            {   if (desc2[i] == LF)
                {   desc2[i] = CR;
            }   }
            thelength = strlen(desc2);
            if (thelength < (int) desclength)
            {   for (i = thelength; i < (int) desclength; i++)
                {   desc2[i] = ' ';
            }   }
            ami_to_pir(desc2);
            strncpy((char*) &IOBuffer[offset], desc2, desclength);
            // *not* zstrncpy() because we don't want to NUL-terminate it!
        }

        offset = 0x23 + desclength;
        serialize1(&location);
        serialize1(&eracode);
        era = 1560 + (eracode * 20);

        offset = 0x5A + desclength;
        if (serializemode == SERIALIZE_READ)
        {   strcpy(name, (char*) &IOBuffer[offset]);
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            strcpy((char*) &IOBuffer[offset], name);
        }

        offset =     7 + desclength; serialize1(     &difficulty);
        offset =  0x10 + desclength; serialize1(     &rescued);
        offset =  0x17 + desclength; serialize1(     &title[0]);
                                     serialize1(     &title[1]);
                                     serialize1(     &title[2]);
                                     serialize1(     &title[3]);
        offset =  0x7A + desclength; serialize4(     &personalgold);
                                     serialize2ulong(&land);
        offset = 0x10C + desclength; serialize2ulong(&crew);
        offset = 0x110 + desclength; serialize2ulong(&cannon);
        offset = 0x112 + desclength; serialize2ulong(&food);
        offset = 0x114 + desclength; serialize2ulong(&sugar);
        offset = 0x118 + desclength; serialize1(     &ships);
        offset = 0x11D + desclength;
        for (i = 0; i < 8; i++)
        {   if (ship[i] >= 9) // damaged
            {   ship[i] += 7; // 9..17 -> 16..23
            }
            serialize1(&ship[i]); // $11D..$124
            if (ship[i] >= 16) // damaged
            {   ship[i] -= 7; // 16..23 -> 9..17
        }   }
        offset = 0x126 + desclength; serialize4(     &partygold);
        offset = 0x12A + desclength; serialize2ulong(&goods);

        offset = 0x192 + desclength;
        if (serializemode == SERIALIZE_READ)
        {   mapfound[ 0] = (IOBuffer[offset] & 1) ? TRUE : FALSE; // upper left
            mapfound[ 1] = (IOBuffer[offset] & 2) ? TRUE : FALSE; // upper right
            mapfound[ 2] = (IOBuffer[offset] & 4) ? TRUE : FALSE; // lower left
            mapfound[ 3] = (IOBuffer[offset] & 8) ? TRUE : FALSE; // lower right
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            t = 0;
            if (mapfound[ 0]) t++;
            if (mapfound[ 1]) t += 2;
            if (mapfound[ 2]) t += 4;
            if (mapfound[ 3]) t += 8;
            IOBuffer[offset] = t;
        }
        offset++;
        serialize1(&map_x[0]);
        serialize1(&map_y[0]);

        offset = 0x19A + desclength;
        if (serializemode == SERIALIZE_READ)
        {   mapfound[ 4] = (IOBuffer[offset] & 1) ? TRUE : FALSE; // upper left
            mapfound[ 5] = (IOBuffer[offset] & 2) ? TRUE : FALSE; // upper right
            mapfound[ 6] = (IOBuffer[offset] & 4) ? TRUE : FALSE; // lower left
            mapfound[ 7] = (IOBuffer[offset] & 8) ? TRUE : FALSE; // lower right
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            t = 0;
            if (mapfound[ 4]) t++;
            if (mapfound[ 5]) t += 2;
            if (mapfound[ 6]) t += 4;
            if (mapfound[ 7]) t += 8;
            IOBuffer[offset] = t;
        }
        offset++;
        serialize1(&map_x[1]);
        serialize1(&map_y[1]);

        offset = 0x1A2 + desclength;
        if (serializemode == SERIALIZE_READ)
        {   mapfound[ 8] = (IOBuffer[offset] & 1) ? TRUE : FALSE; // upper left
            mapfound[ 9] = (IOBuffer[offset] & 2) ? TRUE : FALSE; // upper right
            mapfound[10] = (IOBuffer[offset] & 4) ? TRUE : FALSE; // lower left
            mapfound[11] = (IOBuffer[offset] & 8) ? TRUE : FALSE; // lower right
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            t = 0;
            if (mapfound[ 8]) t++;
            if (mapfound[ 9]) t += 2;
            if (mapfound[10]) t += 4;
            if (mapfound[11]) t += 8;
            IOBuffer[offset] = t;
        }
        offset++;
        serialize1(&map_x[2]);
        serialize1(&map_y[2]);

        offset = 0x1F3 + desclength;
        serialize1(&skipamount);
        offset += (4 * skipamount) - 4;

        if (serializemode == SERIALIZE_READ)
        {   serialize2ulong(&elapseddays);
            days2vars();
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            vars2days();
            serialize2ulong(&elapseddays);
        }

        offset += 36;

        for (i = 0; i < cities[eracode]; i++)
        {   offset++;
            serialize1(&city_x[i]);
            serialize1(&city_y[i]);
            serialize1(&nationality[i]);
            serialize1(&forts[i]);
            serialize1(&soldiers[i]);
            serialize1(&citizens[i]);
            serialize1(&citygold[i]);

            offset += 4;
            if (serializemode == SERIALIZE_READ)
            {   strcpy(cityname[i], (char*) &IOBuffer[offset]);
            } else
            {   // assert(serializemode == SERIALIZE_WRITE);
                ami_to_pir(cityname[i]);
                strcpy((char*) &IOBuffer[offset], cityname[i]);
            }
            pir_to_ami(cityname[i]);
            offset += 16;
        }

        if (serializemode == SERIALIZE_READ)
        {   repositioning = 3;
        }
    acase PIRATES2:
        offset = startoffset;
        serialize1(&difficulty);   // $00

        offset = startoffset + 10;
        serialize1(&title[0]);     // $0A
        serialize1(&title[1]);     // $0B
        serialize1(&title[2]);     // $0C
        serialize1(&title[3]);     // $0D

        offset = startoffset + 0x15;
        serialize1(&location);     // $15
        serialize1(&eracode);      // $16
        era = 1560 + (eracode * 20);

        offset = startoffset + 0x2E;
        if (serializemode == SERIALIZE_READ)
        {   zstrncpy(name, (char*) &IOBuffer[offset], 12);
        } else
        {   // assert(serializemode == SERIALIZE_WRITE);
            strncpy((char*) &IOBuffer[offset], name, 12); // not zstrncpy() because we don't want the terminator if length is 12
        }

        offset = startoffset + 0x3A;
        serialize4(&personalgold); // $3A..$3D
        serialize2ulong(&land);    // $3E..$3F

        offset = startoffset + 0x4C;
        serialize2ulong(&crew);    // $4C..$4D

        offset = startoffset + 0x4F;
        serialize2ulong(&cannon);  // $4F..$50
        serialize2ulong(&food);    // $51..$52
        serialize2ulong(&sugar);   // $53..$54

        offset = startoffset + 0x57;
        serialize1(     &ships);   // $57
        offset = startoffset + 0x59;
        for (i = 0; i < 8; i++)
        {   if (ship[i] >= 9) // damaged
            {   ship[i] += 7; // 9..17 -> 16..23
            }
            serialize1(&ship[i]); //  $59..$60
            if (ship[i] >= 16) // damaged
            {   ship[i] -= 7; // 16..23 -> 9..17
        }   }

        // assert(offset == 0x61);
        serialize4(&partygold);    // $61..$64
        serialize2ulong(&goods);   // $65..$66

        offset = startoffset + 0x68;
        for (i = 0; i < 3; i++)
        {   if (serializemode == SERIALIZE_READ)
            {   mapfound[(i * 4) + 0] = (IOBuffer[offset] & 1) ? TRUE : FALSE; // upper left
                mapfound[(i * 4) + 1] = (IOBuffer[offset] & 2) ? TRUE : FALSE; // upper right
                mapfound[(i * 4) + 2] = (IOBuffer[offset] & 4) ? TRUE : FALSE; // lower left
                mapfound[(i * 4) + 3] = (IOBuffer[offset] & 8) ? TRUE : FALSE; // lower right
            } else
            {   // assert(serializemode == SERIALIZE_WRITE);
                t = 0;
                if (mapfound[(i * 4) + 0]) t++;
                if (mapfound[(i * 4) + 1]) t += 2;
                if (mapfound[(i * 4) + 2]) t += 4;
                if (mapfound[(i * 4) + 3]) t += 8;
                IOBuffer[offset] = t;
            }
            offset += 4;
        }

        offset = startoffset + 0xC7;
        for (i = 0; i < cities[eracode]; i++)
        {   serialize1(&nationality[i]);
            serialize1(&forts[i]);
            serialize1(&soldiers[i]);
            serialize1(&citizens[i]);
            serialize1(&citygold[i]);
            offset += 5;
        }

        if (serializemode == SERIALIZE_READ)
        {   desc[0]     = EOS;
            rescued     =
            elapseddays = 0;
            days2vars();

            for (i = 0; i < 39; i++)
            {   strcpy(cityname[i], (char*) CityOptions[i][eracode]);
}   }   }   }

EXPORT void pir_save(FLAG saveas)
{   readgadgets();
    serializemode = SERIALIZE_WRITE;
    serialize();
    if (game == PIRATES1)
    {   gamesave("#?.pir", "Pirates!"     , saveas, gamesize, FLAG_S, FALSE);
    } else
    {   gamesave("#?"    , "Pirates! Gold", saveas, gamesize, FLAG_S, FALSE); // named PG32 (slave V1.4) or nvram (slave V1.5)
}   }

EXPORT void pir_exit(void)
{   ch_clearlist(&CountryList);
    lb_clearlist(&LocationsList);
    lb_clearlist(&RepositionList);
}

EXPORT void pir_close(void) { ; }

MODULE void maximize_man(void)
{   int i;

    cannon          =      100;
    crew            =      650;
    ships           =        8;
    for (i = 0; i <  8; i++)
    {   ship[i]     =        8; // fast galleon
    }
    for (i = 0; i < 12; i++)
    {   mapfound[i] =     TRUE;
    }
    land            =     1300;
    partygold       =
    personalgold    =    90000;
    title[0]        =
    title[1]        =
    title[2]        =
    title[3]        =        9; // duke
    rescued         =        4;
}

MODULE void citieswindow(void)
{   int i;

    submode = 1;

    for (i = 0; i < cities[eracode]; i++)
    {   gadgets[GID_PIR_LY3 + i] = (struct Gadget*)
        HLayoutObject,
            LAYOUT_VertAlignment,   LALIGN_CENTER,
            LAYOUT_AddChild,        gadgets[GID_PIR_CH15 + i] = (struct Gadget*)
            PopUpObject,
                GA_ID,              GID_PIR_CH15 + i,
                GA_RelVerify,       TRUE,
                CHOOSER_Labels,     &CountryList,
                CHOOSER_Selected,   (WORD) nationality[i],
            PopUpEnd,
            CHILD_WeightedWidth,    0,
            LAYOUT_AddChild,        gadgets[GID_PIR_ST3 + i] = (struct Gadget*)
            StringObject,
                GA_ID,              GID_PIR_ST3 + i,
                GA_TabCycle,        TRUE,
                GA_RelVerify,       TRUE,
                GA_ReadOnly,        (game != PIRATES1) ? TRUE : FALSE,
                STRINGA_TextVal,    cityname[i],
                STRINGA_MaxChars,   15 + 1,
                STRINGA_MinVisible, 15 + stringextra,
            StringEnd,
            AddLabel("  F:"),
            LAYOUT_AddChild,        gadgets[GID_PIR_IN169 + i] = (struct Gadget*)
            IntegerObject,
                GA_ID,              GID_PIR_IN169 + i,
                GA_TabCycle,        TRUE,
                INTEGER_Minimum,    0,
                INTEGER_Maximum,    5,
                INTEGER_Number,     forts[i],
                INTEGER_MinVisible, 1 + 1,
            IntegerEnd,
            AddLabel("  S:"),
            LAYOUT_AddChild,        gadgets[GID_PIR_IN13 + i] = (struct Gadget*)
            IntegerObject,
                GA_ID,              GID_PIR_IN13 + i,
                GA_TabCycle,        TRUE,
                INTEGER_Minimum,    0,
                INTEGER_Maximum,    255,
                INTEGER_Number,     soldiers[i],
                INTEGER_MinVisible, 3 + 1,
            IntegerEnd,
            AddLabel("0  C:"),
            LAYOUT_AddChild,        gadgets[GID_PIR_IN91 + i] = (struct Gadget*)
            IntegerObject,
                GA_ID,              GID_PIR_IN91 + i,
                GA_TabCycle,        TRUE,
                INTEGER_Minimum,    0,
                INTEGER_Maximum,    255,
                INTEGER_Number,     citizens[i],
                INTEGER_MinVisible, 3 + 1,
            IntegerEnd,
            AddLabel("00  $:"),
            LAYOUT_AddChild,        gadgets[GID_PIR_IN247 + i] = (struct Gadget*)
            IntegerObject,
                GA_ID,              GID_PIR_IN247 + i,
                GA_TabCycle,        TRUE,
                INTEGER_Minimum,    0,
                INTEGER_Maximum,    255,
                INTEGER_Number,     citygold[i],
                INTEGER_MinVisible, 3 + 1,
            IntegerEnd,
            AddLabel("000"),
        LayoutEnd;
    }

    InitHook(&ToolSubHookStruct, (ULONG (*)()) ToolSubHookFunc, NULL);
    lockscreen();

    if (!(SubWinObject =
    NewSubWindow,
        WA_Title,                       "Cities",
        WA_SizeGadget,                  TRUE,
        WA_ThinSizeGadget,              TRUE,
        WINDOW_Position,                SPECIALWPOS,
        WINDOW_UniqueID,                "pir-1",
        WINDOW_ParentGroup,             gadgets[GID_PIR_VI1] = (struct Gadget*)
        NewObject(VIRTUAL_GetClass(), NULL,
            GA_ID,                      GID_PIR_VI1,
            GA_RelVerify,               TRUE,
            VIRTUALA_Contents,          gadgets[GID_PIR_LY2] = (struct Gadget*)
            VLayoutObject,
                LAYOUT_SpaceOuter,      TRUE,
                AddCity(0),
                AddCity(1),
                AddCity(2),
                AddCity(3),
                AddCity(4),
                AddCity(5),
                AddCity(6),
                AddCity(7),
                AddCity(8),
                AddCity(9),
                AddCity(10),
                AddCity(11),
                AddCity(12),
                AddCity(13),
                AddCity(14),
                AddCity(15),
                AddCity(16),
                AddCity(17),
                AddCity(18),
                AddCity(19),
                AddCity(20),
                AddCity(21),
                AddCity(22),
                AddCity(23),
                AddCity(24),
                AddCity(25),
                AddCity(26),
                AddCity(27),
                AddCity(28),
                AddCity(29),
                AddCity(30),
                AddCity(31),
                AddCity(32),
                AddCity(33),
                AddCity(34),
                AddCity(35),
                AddCity(36),
                AddCity(37),
                AddCity(38),
                AddCity(39),
                AddCity(40),
                AddCity(41),
                AddCity(42),
                AddCity(43),
                AddCity(44),
                AddCity(45),
                AddCity(46),
                AddCity(47),
                AddCity(48),
                AddCity(49),
                AddCity(50),
                AddCity(51),
                AddCity(52),
                AddCity(53),
                AddCity(54),
                AddCity(55),
                AddCity(56),
                AddCity(57),
                AddCity(58),
                AddCity(59),
                AddCity(60),
                AddCity(61),
                AddCity(62),
                AddCity(63),
                AddCity(64),
                AddCity(65),
                AddCity(66),
                AddCity(67),
                AddCity(68),
                AddCity(69),
                AddCity(70),
                AddCity(71),
                AddCity(72),
                AddCity(73),
                AddCity(74),
                AddCity(75),
                AddCity(76),
                AddCity(77),
            LayoutEnd,
        End,
    WindowEnd))
    {   rq("Can't create gadgets!");
    }
    unlockscreen();
    if (!(SubWindowPtr = (struct Window*) RA_OpenWindow(SubWinObject)))
    {   rq("Can't open window!");
    }
#ifdef MEASUREWINDOWS
    printf(" %d%d\n", SubWindowPtr->Width, SubWindowPtr->Height);
#endif

    subloop();

    for (i = 0; i < cities[eracode]; i++)
    {   DISCARD GetAttr(CHOOSER_Selected, (Object*) gadgets[GID_PIR_CH15  + i], &nationality[i]);
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_PIR_IN13  + i], &soldiers[i]);
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_PIR_IN91  + i], &citizens[i]);
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_PIR_IN169 + i], &forts[i]);
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_PIR_IN247 + i], &citygold[i]);
    }

    remake_cities();

    DisposeObject(SubWinObject);
    SubWinObject = NULL;
    SubWindowPtr = NULL;
}

MODULE void locationwindow(void)
{   int                     i;
    struct ListBrowserNode* ListBrowserNodePtr;

    submode = 0;

    NewList(&LocationsList);

    for (i = 0; i < cities[eracode]; i++)
    {   if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
        (   2,                  // columns,
            LBNA_Column,        0,
            LBNCA_Image,        image[104 + nationality[i]],
            LBNA_Column,        1,
            LBNCA_Text,         cityname[i],
        TAG_END)))
        {   rq("Can't create listbrowser.gadget node(s)!");
        }
        AddTail(&LocationsList, (struct Node*) ListBrowserNodePtr); /* AddTail() has no return code */
    }

    InitHook(&ToolSubHookStruct, (ULONG (*)()) ToolSubHookFunc, NULL);
    lockscreen();

    if (!(SubWinObject =
    NewSubWindow,
        WA_Title,                         "Choose Location",
        WA_SizeGadget,                    TRUE,
        WA_ThinSizeGadget,                TRUE,
        WINDOW_Position,                  WPOS_CENTERMOUSE,
        WINDOW_UniqueID,                  "pir-2",
        WINDOW_ParentGroup,               gadgets[GID_PIR_LY4] = (struct Gadget*)
        VLayoutObject,
            LAYOUT_AddChild,              gadgets[GID_PIR_LB2] = (struct Gadget*)
            ListBrowserObject,
                GA_ID,                    GID_PIR_LB2,
                GA_RelVerify,             TRUE,
                LISTBROWSER_ColumnInfo,   (ULONG) &LocationColumnInfo,
                LISTBROWSER_Labels,       (ULONG) &LocationsList,
                LISTBROWSER_ColumnTitles, FALSE,
                LISTBROWSER_MinVisible,   1,
                LISTBROWSER_ShowSelected, TRUE,
                LISTBROWSER_AutoWheel,    FALSE,
            ListBrowserEnd,
            CHILD_MinWidth,               192,
            CHILD_MinHeight,              450,
        LayoutEnd,
    WindowEnd))
    {   rq("Can't create gadgets!");
    }
    unlockscreen();
    if (!(SubWindowPtr = (struct Window*) RA_OpenWindow(SubWinObject)))
    {   rq("Can't open window!");
    }
#ifdef MEASUREWINDOWS
    printf(" %d%d\n", SubWindowPtr->Width, SubWindowPtr->Height);
#endif

    DISCARD SetGadgetAttrs(         gadgets[GID_PIR_LB2], SubWindowPtr, NULL, LISTBROWSER_Selected,    (ULONG) location, TAG_END);
    RefreshGadgets((struct Gadget*) gadgets[GID_PIR_LB2], SubWindowPtr, NULL);
    DISCARD SetGadgetAttrs(         gadgets[GID_PIR_LB2], SubWindowPtr, NULL, LISTBROWSER_MakeVisible, (ULONG) location, TAG_END);
    RefreshGadgets((struct Gadget*) gadgets[GID_PIR_LB2], SubWindowPtr, NULL);

    subloop();

    DisposeObject(SubWinObject);
    SubWinObject = NULL;
    SubWindowPtr = NULL;

    lb_clearlist(&LocationsList);
}

EXPORT FLAG pir_subkey(UWORD code, UWORD qual)
{   switch (code)
    {
    case SCAN_RETURN:
    case SCAN_ENTER:
        return TRUE;
    acase SCAN_UP:
    case NM_WHEEL_UP:
        if (submode == 0)
        {   lb_move_up(  GID_PIR_LB2, SubWindowPtr, qual, &location, 0,                   5);
            writegadgets(); // only really need to update BU3
        }
    acase SCAN_DOWN:
    case NM_WHEEL_DOWN:
        if (submode == 0)
        {   lb_move_down(GID_PIR_LB2, SubWindowPtr, qual, &location, cities[eracode] - 1, 5);
            writegadgets(); // only really need to update BU3
    }   }

    return FALSE;
}

MODULE void make_cities(void)
{   int                     i;
    struct ListBrowserNode* ListBrowserNodePtr;

    NewList(&RepositionList);

    if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
    (   2,                  // columns,
        LBNA_Column,        0,
        LBNCA_Image,        image[108],
        LBNA_Column,        1,
        LBNCA_Text,         "Pirate treasure",
    TAG_END)))
    {   rq("Can't create listbrowser.gadget node(s)!");
    }
    AddTail(&RepositionList, (struct Node*) ListBrowserNodePtr); /* AddTail() has no return code */
    if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
    (   2,                  // columns,
        LBNA_Column,        0,
        LBNCA_Image,        image[108],
        LBNA_Column,        1,
        LBNCA_Text,         "Family member",
    TAG_END)))
    {   rq("Can't create listbrowser.gadget node(s)!");
    }
    AddTail(&RepositionList, (struct Node*) ListBrowserNodePtr); /* AddTail() has no return code */
    if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
    (   2,                  // columns,
        LBNA_Column,        0,
        LBNCA_Image,        image[108],
        LBNA_Column,        1,
        LBNCA_Text,         "Inca treasure",
    TAG_END)))
    {   rq("Can't create listbrowser.gadget node(s)!");
    }
    AddTail(&RepositionList, (struct Node*) ListBrowserNodePtr); /* AddTail() has no return code */

    for (i = 0; i < cities[eracode]; i++)
    {   if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
        (   2,                  // columns,
            LBNA_Column,        0,
            LBNCA_Image,        image[104 + nationality[i]],
            LBNA_Column,        1,
            LBNCA_Text,         cityname[i],
        TAG_END)))
        {   rq("Can't create listbrowser.gadget node(s)!");
        }
        AddTail(&RepositionList, (struct Node*) ListBrowserNodePtr); /* AddTail() has no return code */
}   }

EXPORT void pir_drawmap(void)
{   int i,
        loc_x, loc_y,
        x, y;

    for (y = 0; y < MAPHEIGHT; y++)
    {   for (x = 0; x < MAPWIDTH; x++)
        {   switch (pir_map[y][x])
            {
            case  '.':           drawpoint(x, y, 0); // dark blue
            acase '-': case '*': drawpoint(x, y, 1); // green
            acase '=':           drawpoint(x, y, 2); // light blue
            acase '!':           drawpoint(x, y, 3); // grey
    }   }   }

    if (game == PIRATES1)
    {   if (repositioning >= 3)
        {   loc_x = city_x[repositioning - 3];
            loc_y = city_y[repositioning - 3];
        } else
        {   loc_x = map_x[repositioning];
            loc_y = map_y[repositioning];
        }

        for (i = 0; i < 39; i++)
        {   if (city_x[i] < MAPWIDTH && city_y[i] < MAPHEIGHT)
            {   drawpoint(city_x[i], city_y[i], 4); // purple
        }   }
        for (i = 0; i <  3; i++)
        {   if ( map_x[i] < MAPWIDTH &&  map_y[i] < MAPHEIGHT)
            {   drawpoint( map_x[i],  map_y[i], 6); // yellow
        }   }

        if (loc_x != -1 && loc_y != -1)
        {   for (x = 0; x < MAPWIDTH; x++)
            {   if (x != loc_x)
                {   drawpoint(x, loc_y, 5); // white
            }   }
            for (y = 0; y < MAPHEIGHT; y++)
            {   if (y != loc_y)
                {   drawpoint(loc_x, y, 5); // white
    }   }   }   }

    DISCARD WritePixelArray8
    (   MainWindowPtr->RPort,
        gadgets[GID_PIR_SP1]->LeftEdge,
        gadgets[GID_PIR_SP1]->TopEdge,
        gadgets[GID_PIR_SP1]->LeftEdge + SCALEDWIDTH  - 1,
        gadgets[GID_PIR_SP1]->TopEdge  + SCALEDHEIGHT - 1,
        display1,
        &wpa8rastport[0]
    );
}

MODULE void drawpoint(int x, int y, int colour)
{   int xx, yy;

    for (yy = 0; yy < MAPSCALEY; yy++)
    {   for (xx = 0; xx < MAPSCALEX; xx++)
        {   *(byteptr1[(y * MAPSCALEY) + yy] + (x * MAPSCALEX) + xx) = pens[colour];
}   }   }

EXPORT void pir_uniconify(void)
{   pir_getpens();
    pir_drawmap();
}

EXPORT void pir_getpens(void)
{   lockscreen();

    pens[0] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x00000000, 0x00000000, 0x88888888, -1); // dark blue
    pens[1] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x00000000, 0x88888888, 0x00000000, -1); // green
    pens[2] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x44444444, 0x44444444, 0xFFFFFFFF, -1); // light blue
    pens[3] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x88888888, 0x88888888, 0x88888888, -1); // grey
    pens[4] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0x00000000, 0xFFFFFFFF, -1); // purple
    pens[5] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, -1); // white
    pens[6] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0xFFFFFFFF, 0x00000000, -1); // yellow

    unlockscreen();
}

EXPORT void pir_lmb(SWORD mousex, SWORD mousey, UWORD code)
{   if (game != PIRATES1)
    {   return;
    }

    if
    (   code != SELECTDOWN
     || mousex < gadgets[GID_PIR_SP1]->LeftEdge
     || mousey < gadgets[GID_PIR_SP1]->TopEdge
     || mousex > gadgets[GID_PIR_SP1]->LeftEdge + SCALEDWIDTH  - 1
     || mousey > gadgets[GID_PIR_SP1]->TopEdge  + SCALEDHEIGHT - 1
    )
    {   return;
    }

    if (repositioning >= 3)
    {   city_x[repositioning - 3] = ((mousex - gadgets[GID_PIR_SP1]->LeftEdge) / MAPSCALEX);
        city_y[repositioning - 3] = ((mousey - gadgets[GID_PIR_SP1]->TopEdge ) / MAPSCALEY);
    } else
    {   map_x[ repositioning    ] = ((mousex - gadgets[GID_PIR_SP1]->LeftEdge) / MAPSCALEX);
        map_y[ repositioning    ] = ((mousey - gadgets[GID_PIR_SP1]->TopEdge ) / MAPSCALEY);
    }

    pir_drawmap();
}

EXPORT void pir_key(UBYTE scancode, UWORD qual, SWORD mousex, SWORD mousey)
{   int loc_x,    loc_y,
        oldloc_x, oldloc_y;

    if (game != PIRATES1)
    {   return;
    }

    if (repositioning >= 3)
    {   loc_x = city_x[repositioning - 3];
        loc_y = city_y[repositioning - 3];
    } else
    {   loc_x = map_x[repositioning];
        loc_y = map_y[repositioning];
    }
    oldloc_x = loc_x;
    oldloc_y = loc_y;

    switch (scancode)
    {
    case SCAN_LEFT:
    case SCAN_N4:
        map_leftorup(qual, MAPWIDTH, &loc_x, 0, NULL);
    acase SCAN_RIGHT:
    case SCAN_N6:
        map_rightordown(qual, MAPWIDTH, &loc_x, 0, NULL);
    acase SCAN_UP:
    case SCAN_N8:
    case NM_WHEEL_UP:
        if (mouseisover(GID_PIR_SP1, mousex, mousey))
        {   map_leftorup(qual, MAPHEIGHT, &loc_y, 0, NULL);
        } else
        {   lb_move_up(GID_PIR_LB1, MainWindowPtr, qual, &repositioning, 0, 5);
            pir_drawmap();
        }
    acase SCAN_DOWN:
    case SCAN_N5:
    case SCAN_N2:
    case NM_WHEEL_DOWN:
        if (mouseisover(GID_PIR_SP1, mousex, mousey))
        {   map_rightordown(qual, MAPHEIGHT, &loc_y, 0, NULL);
        } else
        {   lb_move_down(GID_PIR_LB1, MainWindowPtr, qual, &repositioning, 3 + cities[eracode] - 1, 5);
            pir_drawmap();
        }
    acase SCAN_N1:
        map_leftorup(qual, MAPWIDTH, &loc_x, 0, NULL);
        map_rightordown(qual, MAPHEIGHT, &loc_y, 0, NULL);
    acase SCAN_N3:
        map_rightordown(qual, MAPWIDTH, &loc_x, 0, NULL);
        map_rightordown(qual, MAPHEIGHT, &loc_y, 0, NULL);
    acase SCAN_N7:
        map_leftorup(qual, MAPWIDTH, &loc_x, 0, NULL);
        map_leftorup(qual, MAPHEIGHT, &loc_y, 0, NULL);
    acase SCAN_N9:
        map_rightordown(qual, MAPWIDTH, &loc_x, 0, NULL);
        map_leftorup(qual, MAPHEIGHT, &loc_y, 0, NULL);
    }

    if (oldloc_x == loc_x && oldloc_y == loc_y)
    {   return;
    }

    if (repositioning >= 3)
    {   city_x[repositioning - 3] = loc_x;
        city_y[repositioning - 3] = loc_y;
    } else
    {   map_x[ repositioning    ] = loc_x;
        map_y[ repositioning    ] = loc_y;
    }
    pir_drawmap();
}

EXPORT FLAG pir_subgadget(ULONG gid, UNUSED UWORD code)
{   switch (gid)
    {
    case GID_PIR_LB2:
        DISCARD GetAttr(LISTBROWSER_Selected, (Object*) gadgets[GID_PIR_LB2], (ULONG*) &location);
        writegadgets();
        return TRUE;
    adefault:
        if     (gid >= GID_PIR_CH15 && gid < GID_PIR_CH15 + 78)
        {   DISCARD GetAttr(CHOOSER_Selected, (Object*) gadgets[gid], &nationality[gid - GID_PIR_CH15]);
            writegadgets();
        } elif (gid >= GID_PIR_ST3 && gid < GID_PIR_ST3 + 78)
        {   // no need to GetAttr()
            writegadgets();
    }   }

    return FALSE;
}

MODULE void pir_to_ami(STRPTR text)
{   int i = 0;

    for (;; i++)
    {   switch (text[i])
        {
        case  0x87: text[i] = (TEXT) ''; // $E1
        acase 0x89: text[i] = (TEXT) ''; // $E2
        acase 0x8D: text[i] = (TEXT) ''; // $E7
        acase 0x8E: text[i] = (TEXT) ''; // $E9
        acase 0x92: text[i] = (TEXT) ''; // $ED
        acase  EOS: return;
}   }   }

MODULE void ami_to_pir(STRPTR text)
{   int i = 0;

    for (;; i++)
    {   switch (text[i])
        {
        case   '': text[i] = 0x87;
        acase  '': text[i] = 0x89;
        acase  '': text[i] = 0x8D;
        acase  '': text[i] = 0x8E;
        acase  '': text[i] = 0x92;
        acase  EOS: return;
}   }   }

EXPORT void pir_tick(SWORD mousex, SWORD mousey)
{   if (game == PIRATES1 && mouseisover(GID_PIR_SP1, mousex, mousey))
    {   setpointer(TRUE , WinObject, MainWindowPtr, FALSE);
    } else
    {   setpointer(FALSE, WinObject, MainWindowPtr, FALSE);
}   }

MODULE void remake_cities(void)
{   SetGadgetAttrs(                     gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Labels,              ~0,                     TAG_END);
    lb_clearlist(&RepositionList);
    make_cities();
    SetGadgetAttrs(                     gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Labels,              &RepositionList,        TAG_END);
    if (game == PIRATES1)
    {   SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Selected,    (ULONG) repositioning,          TAG_END);
        RefreshGadgets((struct Gadget*) gadgets[GID_PIR_LB1], MainWindowPtr, NULL);
        SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_MakeVisible, (ULONG) repositioning,          TAG_END);
    } else
    {   SetGadgetAttrs(                 gadgets[GID_PIR_LB1], MainWindowPtr, NULL, LISTBROWSER_Selected,    (ULONG) ~0,                     TAG_END);
    }
    RefreshGadgets(    (struct Gadget*) gadgets[GID_PIR_LB1], MainWindowPtr, NULL);
    SetGadgetAttrs(                     gadgets[GID_PIR_LB1], MainWindowPtr, NULL, GA_Disabled, (game != PIRATES1) ? TRUE : FALSE, TAG_DONE);
}
