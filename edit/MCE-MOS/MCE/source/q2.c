// 1. INCLUDES -----------------------------------------------------------

#ifdef __amigaos4__
    #ifndef __USE_INLINE__
        #define __USE_INLINE__ // define this as early as possible
    #endif
#endif
#ifdef __LCLINT__
    typedef char* STRPTR;
    typedef char* CONST_STRPTR;
    typedef char  TEXT;
    #define ASM
    #define REG(x)
    #define __inline
#endif

#include <exec/types.h>
#include <exec/memory.h>
#include <dos/dos.h>
#include <intuition/intuition.h>
#define ALL_REACTION_CLASSES
#define ALL_REACTION_MACROS
#include <reaction/reaction.h>

#include <proto/dos.h>
#include <proto/exec.h>
#include <proto/graphics.h>
#include <proto/intuition.h>
#include <clib/alib_protos.h>

#include <ctype.h>
#include <stdio.h>                           /* FILE, printf() */
#include <stdlib.h>                          /* EXIT_SUCCESS, EXIT_FAILURE */
#include <string.h>
#include <assert.h>

#ifdef LATTICE
    #include <dos.h>                         // geta4()
#endif

#include "mce.h"

// 2. DEFINES ------------------------------------------------------------

// main window
#define GID_Q2_LY1    0 // root layout
#define GID_Q2_SB1    1 // toolbar
#define GID_Q2_ST1    2 // name
#define GID_Q2_ST2    3 // description
#define GID_Q2_BU1    4 // invert items
#define GID_Q2_BU2    5 // maximize character
#define GID_Q2_IN1    6 // hit points
#define GID_Q2_IN2    7 // food
#define GID_Q2_IN3    8 // gold
#define GID_Q2_IN4    9 // time
#define GID_Q2_IN5   10 // X
#define GID_Q2_IN6   11 // Y
#define GID_Q2_IN7   12 // cha
#define GID_Q2_IN8   13 // str
#define GID_Q2_IN9   14 // agi
#define GID_Q2_IN10  15 // sta
#define GID_Q2_IN11  16 // int
#define GID_Q2_IN12  17 // magic missile
#define GID_Q2_IN13  18 // fireball
#define GID_Q2_IN14  19 // sonic whine
#define GID_Q2_IN15  20 // time sap
#define GID_Q2_IN16  21 // bread of life
#define GID_Q2_CH1   22 // rank
#define GID_Q2_CH2   23 // mount
#define GID_Q2_CH3   24 // armed weapon
#define GID_Q2_CH4   25 // worn armour
#define GID_Q2_CH5   26 // realm
#define GID_Q2_LB1   27 // item in use
#define GID_Q2_LB2   28 // items
#define GID_Q2_BU3   29 // all
#define GID_Q2_BU4   30 // none
#define GID_Q2_SP1   31 // map
#define GIDS_Q2      GID_Q2_SP1

#define ITEMS        24

#define MAPWIDTH     90
#define MAPHEIGHT    90
#define MAPSCALE      3
#define SCALEDWIDTH  (MAPWIDTH  * MAPSCALE)
#define SCALEDHEIGHT (MAPHEIGHT * MAPSCALE)

#define LIGHTGREEN    0
#define BLUE          1
#define RED           2
#define DARKGREEN     3
#define ORANGE        4
#define GREY          5
#define WHITE         6

// 3. MODULE FUNCTIONS ---------------------------------------------------

MODULE void readgadgets(void);
MODULE void writegadgets(void);
MODULE void maximize_man(void);
MODULE void eithergadgets(void);
MODULE UBYTE theencrypt(UBYTE input);
MODULE UBYTE getcryptbyte(void);
MODULE UWORD getcryptword(void);
MODULE void drawpoint(int x, int y, int colour);
MODULE STRPTR specialdesc(int x, int y, int realm);

/* 4. EXPORTED VARIABLES -------------------------------------------------

(none)

5. IMPORTED VARIABLES ------------------------------------------------- */

IMPORT int                  function,
                            gadmode,
                            loaded,
                            page;
IMPORT LONG                 gamesize,
                            pens[PENS];
IMPORT TEXT                 pathname[MAX_PATH + 1];
IMPORT ULONG                offset,
                            showtoolbar;
IMPORT UBYTE                IOBuffer[IOBUFFERSIZE];
IMPORT struct HintInfo*     HintInfoPtr;
IMPORT struct Hook          ToolHookStruct;
IMPORT struct IBox          winbox[FUNCTIONS + 1];
IMPORT struct List          SpeedBarList;
IMPORT struct Window*       MainWindowPtr;
IMPORT struct Menu*         MenuPtr;
IMPORT struct Screen       *CustomScreenPtr,
                           *ScreenPtr;
IMPORT struct DiskObject*   IconifiedIcon;
IMPORT struct MsgPtr*       AppPort;
IMPORT struct Gadget*       gadgets[GIDS_MAX + 1];
IMPORT struct DrawInfo*     DrawInfoPtr;
IMPORT struct Image        *aissimage[AISSIMAGES],
                           *image[BITMAPS];
IMPORT Object*              WinObject;
IMPORT struct RastPort      wpa8rastport[2];
IMPORT UBYTE*               byteptr1[DISPLAY1HEIGHT];
IMPORT __aligned UBYTE      display1[DISPLAY1SIZE];

// function pointers
IMPORT FLAG (* tool_open)  (FLAG loadas);
IMPORT void (* tool_save)  (FLAG saveas);
IMPORT void (* tool_close) (void);
IMPORT void (* tool_loop)  (ULONG gid, ULONG code);
IMPORT void (* tool_exit)  (void);

// 6. MODULE VARIABLES ---------------------------------------------------

MODULE ULONG                rank, mount, armed, worn,
                            cha, str, agi, sta, iq,
                            magicmissile, fireball, sonicwhine, timesap,
                            breadoflife, hp, food, gp, time,
                            iteminuse,
                            item[44],
                            realm;
MODULE LONG                 location_x, location_y;
MODULE TEXT                 name[14 + 1];
MODULE struct List          ItemsList1,
                            ItemsList2,
                            MountList,
                            RankList;

MODULE const STRPTR ArmourOptions[8 + 1] =
{ "Rawhide",         //  0
  "Studded Leather",
  "Ring Mail",
  "Bar Mail",
  "Chain Mail",
  "Plate Mail",
  "Ribbed Plate",
  "None",            //  7
  NULL               //  8
}, WeaponOptions[15 + 1] =
{ "Dagger",          //  0
  "Hammer",
  "Hatchet",
  "Staff",
  "Cudgel",
  "Rapier",
  "Axe",
  "Fauchard",
  "Sabre",
  "Weighted Spear",
  "Pike",            // 10
  "Shortbow",
  "Broadsword",
  "Crossbow",
  "None",            // 14
  NULL               // 15
}, RealmOptions[2 + 1] =
{ "Landor",          //  0
  "Realm of Sorcerers",
  // no NULL is required
}, MountOptions[6] =
{ "None",            //  0
  "Bird",
  "Ship",
  "Donkey",
  "Horse",
  "Camel",           //  5
  // no NULL is required
}, RankOptions[6] =
{ "Plebe",           //  0
  "Adventurer",
  "Scout",
  "Apprentice",
  "Knight",
  "Priest"           //  5
  // no NULL is required
}, ItemNames1[ITEMS] =
{ "Gold Key",        //  0
  "Opal Key",
  "Iron Key",
  "Brass Key",
  "Copper Key",
  "Silver Key",
  "Emerald Key",
  "Onyx Key",
  "Ruby Key",
  "Agate Key",
  "Sapphire Key",    // 10
  "Black Key",
  "Diamond",
  "Unicorn Horn",
  "Wand of Power",
  "Eternal Flame",
  "Book of Magic",
  "Crystal Goblet",
  "Chalice of Arvyl",
  "Moonstone Amulet",
  "Orb of Enchantment", // 20
  "Scroll of Scalna",
  "Rope & Hooks",
  "None"             // 23
  // no NULL is required
}, ItemNames2[44] =
{ "Dagger",          //  0
  "Hammer",
  "Hatchet",
  "Staff",
  "Cudgel",
  "Rapier",
  "Axe",
  "Fauchard",
  "Sabre",
  "Weighted Spear",
  "Pike",            // 10
  "Shortbow",
  "Broadsword",
  "Crossbow",
  "Rawhide",
  "Studded Leather",
  "Ring Mail",
  "Bar Mail",
  "Chain Mail",
  "Plate Mail",
  "Ribbed Plate",    // 20
  "Gold Key",
  "Opal Key",
  "Iron Key",
  "Brass Key",
  "Copper Key",
  "Silver Key",
  "Emerald Key",
  "Onyx Key",
  "Ruby Key",
  "Agate Key",       // 30
  "Sapphire Key",
  "Black Key",
  "Diamond",
  "Unicorn Horn",
  "Wand of Power",
  "Eternal Flame",
  "Book of Magic",
  "Crystal Goblet",
  "Chalice of Arvyl",
  "Moonstone Amulet",// 40
  "Orb of Enchantment",
  "Scroll of Scalna",
  "Rope & Hooks"     // 43
  // no NULL is required
};

MODULE const STRPTR q2_map[2][MAPHEIGHT] = { {
"------------------------------------------------------------------------------------------",
"-------------------------------#-------------##-------------------------------------------",
"---------####-----------------####----------####------------------------------------------",
"--------#%%##-------######----#####---------#####-----------------------------------------",
"------#####----###--#######--#######------########----------------------------------------",
"------#####---####---######-#$$##$$#--#--#########-----------------------##---------------",
"-------#####################$$$##$$$#-##-###!######---------------------###-##------------",
"--------#####^^^^##^########$$$$$$$$$#---##!#!#!######------###-------########------------",
"----------##^^^^^^##^#########$$$$$$$#---#!#!!#!###%%##-----#^^#----##!##!!$$#------------",
"----------#^^^^^^#^^^##########$$$$$#----#!!###!###%%##----#^^^^######!!!!%%$$#-----------",
"----------#^^^^^^^^#^###!#####$$$$$$#----#!!##!#!######---#^^^^^^#########!#!$$#----------",
"-----------##^^^^^^^^##!##!###$$$$$##--##-#!!#!#!######--#^^^^^^^#######!#!#!$$$#---------",
"----------#%%##^^^#^#^!##!!$$$$$#$$##--###-#!!!#!####----#^^^^^^^####!!#!#!!#$$$#---------",
"----------#%%#^#^^##^###!!#$$$$$######-##-##!#!#!####-#-#^#^^^^^^^###!!!#!#!#####---------",
"---------####^^^^^#####!!##$$$$##############!!!#######-##^##^^^^###!!##!#!!####----------",
"-------####^#######^#######$$$$$$%%######################^^#^^#^#^####!!$$$##-------------",
"-------####^^#^^#^###########$$#$$#########################^#########$$#$$$#--------------",
"--------####^^^#^^###########$$############################^##^#^####$$#$$#---------------",
"--------###^#^^^^############################################^######$$$$#$$#--------------",
"------##--##^^^^###########################################^####^###$$$$#$$$#-------------",
"------#####^^^^^^###########################################^#^######$$$#$$$$#------------",
"------####^^^^^^^^########################################^^#^##^####$$###$$$#------------",
"----#-#####^^^^^^######################################^#^^^^^^#######$$$$$$#-------------",
"---###-###^^^^^^^########################################^^^^^^^^##^##$$$$###-------------",
"--###----##^^^^^^###################################^##^^^^^^^^^^^########----------------",
"--####-##-####^^#^####!!##############################^^^^^^^^^^^########-----------------",
"-------###-##^^#######!!################$$##########^##^^^^^^^^^######--------------------",
"-------#############!#!!#############$$$$$$#######^^^^^^^^^^^^^^^######-------------------",
"---------#########!#!####!##########$$$$$$$########^^^^^^^^^^^^#########------------------",
"--------#############!!###!#########$$$$$$########^^^^^^^^^^#^#^########------------------",
"--------###########!#!#!!##########$$$$$$$#######^^^^^#^^#^############-------------------",
"-------###--#--####!!!!##!!!!######$$$$$$$########^^^^###^#####-######--------------------",
"-------##------#####################$$$$###################-###-###-----------------------",
"----------------------######^#^#^####$$##############-##----------------------------------",
"----------------------####^##^#^##################$$#----------------##-------------------",
"--------------------##%%###^##^#################$$$$$###-----------###^##-----------------",
"--------------------#########^^#################$$$$$%%##-------###^#^^^##----------------",
"-----------------###-##!!##^#^#^################$$$$$$$$$####--####^^^^^^##---------------",
"----------------#############^^################$$$$$$$$$$$########^^^^^^^^#---------------",
"---------------#########!#^#^#^################$$$$$$$$$$$########^^^^^^^^#---------------",
"----------###########!!##^^^^^#################$$$$$$$$$$######^^#^^^^^^^###--------------",
"---------############!!!^^^^^^#################$$$##$$$#######^^^^#^^^^^^^##--------------",
"---------#######--##!!#^^^^^^^^#################$$##$$$#########^##!!##%%###--------------",
"--------#-####---#####^^^^^^^^^^#######################################^###---------------",
"-------#######--#####^^^^^^^^^^^^%%#########################!#!##!!!!!####----------------",
"-------######--###^#^^^^^^^^^^^^^^^^############################!###########--------------",
"----##---####-#######^^^^^^^^^^^^^^^^^###^##################!!!!!############-------------",
"----##-###########^#^^^^^^^^^^^^^^^^^^^#######################!######!!!!####-------------",
"------##############^^^^^^^^^^^^^^^^^^^^#########################!###########-------------",
"------#############^^^^^^^^^^^^^^^^^^^^^^^#################!#!#!!#############------------",
"------###########^#^^^^^^^^^^^^^^^^^^^^^^^##################!##!#!#!##^#^#####------------",
"------##############^^^^^^^^^^^^^#^^^^^^^^^################!!####!!#^########-------------",
"---------############!^^%%###^###^^^^^^^^^####################!#!!####^#######------------",
"----------#########!!!#############^^^^^^^#################!#!####%%^^^^#######-----------",
"----------#####--###^######^##^###^^^^^^^^#^####################!!##^^^^#######-----------",
"-----------###--#################^#^^^^^^####!!############!!!#!####^#^##^####------------",
"---------------####################^^^^^###!##!############!!#!#!#^##^#^####--------------",
"---------------###########################################!!!!###!#####^#-----------------",
"-------------------################^##!##!#!####!###########!!#!########------------------",
"-------------###---###################!#!#!!!###!##########%%#!########-------------------",
"-------------###---##################!##!!!###!!###########%%##!#!#!!###------------------",
"-------------###----####################!!#!!!!##!#!#########!!#!!#!######----------------",
"--------------------##################!!#####$$!!##!!!#########!##!#######----------------",
"---------------------#$$###################$$$$$#!!#!#!#!########!!!######----------------",
"---------------------#$$##################$$##$$$#!!#!##!######!!!!########---------------",
"--------------------#$$$$###############$$$$#-#$$$###!###!##################--------------",
"----------------##--#$$$$###############$$###--#$$!##!!##!####-----#########--------------",
"----------------##-##$$$##^#####--##########----#$$!!!#!######------#######---------------",
"-----------------##$$$$$^^######--######$$#-----#$$####!!!######-----######---------------",
"---------------###$$$$$^^^^#############$$#-----#$$$!!!###########---########-------------",
"--------------####$$$$$^^^^###-#############---#$$$$###############--########-------------",
"------------#######$$$^^^^##---#############----#$$$#############!###########-------------",
"------------#########^^^^###---#########$$#-----#$$$############!##%%#!######-------------",
"-----------#####%%#^#^^^##------#########$$#-----#$$######--#####!!###!######-------------",
"-----------#####%%###^^#-#--------#######$$#----##$$####---####!#####!######--------------",
"------------########^##-----------##-####$$#---#$$#####--#######!!!#####!###--------------",
"-------------######-##--------------####$$$#---#$$$###############!##!#!!##---------------",
"--------------#####-##-------------#####$$$$#--##$$$############--#!########--------------",
"----------------##--##-------------#####$$$$#---#$$$$$#####!####--##########--------------",
"-------------------------------------###$$$#---#%%$$$$##!#!####----#!!!!!####-------------",
"--------------------##---------------#-#$$$#---#$$$$###!#!#$$#-----##########-------------",
"--------------------##-----------------##$$#---#$$$$#!!#!!!$$#------########--------------",
"----------------##----------------------#$$#---##########$$$$#-------######---------------",
"----------------##----------------------####--------###$$$$$$#--------####----------------",
"-----------------------------------------------------##$$####-----------------------------",
"-------------------------------------------------------##---------------------------------",
"------------------------------------------------------------------------------------------",
"------------------------------------------------------------------------------------------",
"------------------------------------------------------------------------------------------",
"------------------------------------------------------------------------------------------",
}, {
"------------------------------------------------------------------------------------------",
"---######-####-##-----##------------------------------------------------------------------",
"--################----##------------------------------------------------------------------",
"--###################-###--------------------------##-------------------------------------",
"--########################-------------------------#####----####--------------------------",
"--##-#####^^^^^^^###########-----------------------######--########-----------------------",
"--##-##^^^^^^^^^^^^^#########----------------------####%%##########-----------------------",
"--##-##^^^^^^^^^^^^^######!###--------------------#################-----------###---------",
"-#######^^^^^^^^^^^^^##!#!!#!##-------------------##########!######-----------###---------",
"-##-####^^^^^^^^^^^^%%!!#!##!##--------------------#####!!###!#####-----------------------",
"----###%%^^^^^^^^^^^^^^^##!!###------------------------##############---------------------",
"------#%%^^^^^^^^^^^^^^^!!!#####-----------------------##!####!######-----------#---------",
"-------##^^^^^^^^^^^^^^^^^^#####-----------------------###!!!!######------------#---------",
"-------###^^^^^^^^^^^^^^^^^#####-----------------------###############--------------------",
"-------###########^^^^^^^^^^#####-----------------##---################-------------------",
"----------###-##-######^^^^^#####-----------------########!#!##!#!!####-----------##------",
"----------------####--#^^^^^^^###-----------------########!##!##!###--------------###-----",
"------------##--####-##^^^^^^^###-----------------##$$####!!!##!#####-------------####----",
"------------##----####^^^^^^^^^###-------------#####$$$#####!##!!#####-------------###----",
"---##--###----------###^^^^^^^^#^##------------####$$$$####!########-#--------------------",
"---####$$#----------###^^^^^^^^^###------------###$$$$$####!####!##-----------------------",
"---#$$$$$#----------###^^^^^^^^^^##------------###$$$$$###!#!#!!###-----------------------",
"---#$$$$$#####-------###^^^^^^^^^^##-----------###$$$$$##!!##########---------------------",
"-###$$$$$$$$$#----------#^^^^^^^^^^##------------#$$$$###%%!#!!#!#!###--------------------",
"-###$$$$$$$$$#----------##^^^^^^^^^#^#--------####$$$$######!!!!########-----##-##--------",
"-###$$$$$$$$$#----------####^^^^^^^^##--------####$$$#####!!!#!#!#!!!###-######-##--------",
"-###$$$$$$$$$#-##---------##^^^^^^^###------###$$$$$#############!################--##----",
"--#$$$$$$$$$$#-##-----##---#^^^^^^^^^#------##$$$$#$$#################################----",
"---##$$$$$$$$##-####--##--##^^^^^^^^#-------##$$$$#$$##########!!#######################--",
"---##$$$$$$$$##-####-----####^^^^^^^##------###$$###########################$$##$$###$$#--",
"----#$$$$$$$$##--####----#####^#^^#####-----###$$###!#######################$$#$$$$$$$$##-",
"----#$$$$$$$$$###-####----#######^#####------#####!#!##!#################$$$$$$$$$$$$$$##-",
"-----#$$$$$$$$$$#######--##############--------###!##!#################$$$$$$$$$$$$$$$###-",
"----##$$$$$$$$$$$$$########!!#########----------###!!##!!####$$########$$$$$$$$$$$$$$##---",
"----##$$$$%%$$$$$$$###################----------####!!!###$$$$$$########$$$$$$$$$$$$#$$#--",
"-----#$$$$$$$$$$$###################------------##########$$$$$$#####$$$$$$$$#%%$$$$$$$#--",
"-----#$$$$$$$$$########################---------####---###$$$$$$#####$$$#$$$$$##$$$$$$$#--",
"------#$$$$$$$$$#######################----##----###--####$$$$$########$$$$$$$$$$$$$$$$#--",
"-----#$$$$$$$$$$#$$####################----###----##--####$$$$#########$$$$$$$$$$$$$$$$#--",
"-####$$$$$$$$$$##$$############!!!#####---####-#------##################$$$$$$$$$$$$$$##--",
"-###$$$$$####$$#########!##!#####################----####################$$$$$$$#$$$$$##--",
"-###$$$$$##################!#####################----####################$$##$$$#$$$$####-",
"----##################!#!##!##$$####^^#^^^#^#####----#############----##################--",
"-------###############!####!$$$$###^^^^^^^^^^######---#############----##################-",
"--##----###############!!#!#$$#####^^^^^^^^^^######----##############-##################--",
"--##---###############!!!!#$$$####^^^^^^^^^^^^####-----##############-##############%%%#--",
"-###--################!####$$#####^^^^^%%%^^^^^^##-----##############---################--",
"-###--###############!##########^^^^^^^^^^^^^^^^%%#---##############----################--",
"-------#########!#!!###!#######^^^^^^^^^^^^^^^^^^###################----#############-----",
"----##########!######!#########^^^^^^^^^^^^^^^^^^^##################----##########-##-----",
"----###########!###!!#!#########^^^^^^^^^^^^^^^^^^################------#########---------",
"----#!#####!#!!##!###!#!#########^^^^^^^^^^^^^^^^^##############--------########----------",
"-----###!######!!!###!!!!########^^^^^^^^^^^^^^^^^##############-----------#####----------",
"---###!!#####!!####!!############^^^^^^^^^^^^^^^^###############--------------------------",
"---####!#!##!#!#!###!######$$########^^^^^^^^^^^^################-------------------------",
"---###!!######!####!!######$$#$$$$###^^^^^^^^^^^########!#!######-------------------#-----",
"-######!!!!!!!#!!####!####$$$#$$$$$###^^^^^^^^^##########!#########---##-----------###----",
"-##--#%%######!#!!#!#!###$$$$$$$$$$####^^^^^^^^^#########!!########---##----------######--",
"----#####---###!##!!!###$$$$$$$$$$$$##^##^^^^^^####################---------------######--",
"---#####-----#!!!!!#####$$$$$$$$$$$$#####^^^^^^^####################----------------####--",
"---######----#########$$$$$$$$$$$$#######^^^^^^^################^#######-----------#####--",
"---######----########$$$$$$$$$$$$$###---#^^^^^^^###############^^^######-####------####---",
"----###------########$$$$$$$$$$$$$##----#^^^^^^^^^#############^^############-------------",
"-----##-----#######$$$$$$$$$$$$$$####--##^^^^^^^^^^##!!!#######^^^^##########-##----------",
"------------#######$$#$$$$$$$$$######--###^^^^^^^^^##########^^^^^^^#^##########----------",
"---##--------##-######$$$$$$$$$####-----##^^^^^^^^^#########^^^^^^^################-------",
"--####---------#####$$$$$$$$$$$###------###^^^^^^^^#########^^^^^^^%%###############------",
"--####------##-#####$$$$$$$$$$####------###################^^^^^^^^^^###############------",
"--###------#########$$$$$$$$#######------#################^^^^^^^^^^^#^###########--------",
"-----------###########$$$$$$#-#####-------#################^^^^^^^^^^############---------",
"-----------#####-----##$$$$#--#####-------#################^^^^^^^^^^^###$$######---------",
"---------#######------#$$$#----####-------##################^^^^^^^^^###$$$$#####---------",
"---------#######----##$$$$#---####--------####-#################^^^^####$$$$########------",
"--------#######-----##$$$$#---###--------#####-########################$$$$$$$######------",
"--------#####--##---#$$$$#----##---------#####-####################^###$$$$$$$########----",
"--------#####--###--#$$$$#----------------####-############^############$$$$$$########----",
"--------####---###--#$$$#-----##-##---------##-############^^^^##########$$$$$$#######----",
"--##---####----##---#$##------##-##--------------#########^^^^^^#########$$$$$$$#######---",
"--####-###----###---#$$##--------###------#-------########^^^^^^^########$$#$$$$#######---",
"----############---##$$##--------###-----###-------#######^^^^^^^#######$$$$$$$$#######---",
"-----##########----##$$##---------##-----###----------###^^^^^^^^######$$$$$$$$$$######---",
"-----#########-----######---------##------##----------#####^^^^^^######$$$$$$$#$$######---",
"-----####---------#####-----------##-------------------###^^^^^^^#####$$$$$$$$#########---",
"-----####---------#####-------------------##------------#####^^^^^####$$$$$$#########-----",
"----#####----------###--------------------##-----##-----####^^^^^^####$$$$$#---######-----",
"----######---##---###--------------------------####-------############$$###-######--------",
"-----########%%#########-----------------------###--------#####--####-#####-#####-----###-",
"------##################------##---------------###-----------#----##-----##-#####-----###-",
"-------############-----------##------------------------------------------------------###-",
"------------------------------------------------------------------------------------------",
} };

MODULE const UBYTE thedecrypt[256] =
{
 181, // $00
 170, // $01
 171, // $02
 168, // $03
 169, // $04
 174, // $05
 175, // $06
 172, // $07
 173, // $08
 162, // $09
 163, // $0A
 160, // $0B
 161, // $0C
 166, // $0D
 167, // $0E
 164, // $0F
 165, // $10
  90, // $11
  91, // $12
  88, // $13
  89, // $14
  94, // $15
  95, // $16
  92, // $17
  93, // $18
  82, // $19
  83, // $1A
  80, // $1B
  81, // $1C
  86, // $1D
  87, // $1E
  84, // $1F
  85, // $20
  74, // $21
  75, // $22
  72, // $23
  73, // $24
  78, // $25
  79, // $26
  76, // $27
  77, // $28
  66, // $29
  67, // $2A
  64, // $2B
  65, // $2C
  70, // $2D
  71, // $2E
  68, // $2F
  69, // $30
 122, // $31
 123, // $32
 120, // $33
 121, // $34
 126, // $35
 127, // $36
 124, // $37
 125, // $38
 114, // $39
 115, // $3A
 112, // $3B
 113, // $3C
 118, // $3D
 119, // $3E
 116, // $3F
 117, // $40
 106, // $41
 107, // $42
 104, // $43
 105, // $44
 110, // $45
 111, // $46
 108, // $47
 109, // $48
  98, // $49
  99, // $4A
  96, // $4B
  97, // $4C
 102, // $4D
 103, // $4E
 100, // $4F
 101, // $50
  26, // $51
  27, // $52
  24, // $53
  25, // $54
  30, // $55
  19, // $56
  18, // $57
  29, // $58
  28, // $59
  31, // $5A
  16, // $5B
  17, // $5C
  22, // $5D
  23, // $5E
  20, // $5F
  21, // $60
  10, // $61
  11, // $62
   8, // $63
   9, // $64
  14, // $65
  15, // $66
  12, // $67
  13, // $68
   2, // $69
   3, // $6A
   0, // $6B
   1, // $6C
   6, // $6D
   7, // $6E
   4, // $6F
   5, // $70
  58, // $71
  59, // $72
  56, // $73
  57, // $74
  62, // $75
  63, // $76
  60, // $77
  61, // $78
  50, // $79
  51, // $7A
  48, // $7B
  49, // $7C
  54, // $7D
  55, // $7E
  52, // $7F
  53, // $80
  42, // $81
  43, // $82
  40, // $83
  41, // $84
  46, // $85
  47, // $86
  44, // $87
  45, // $88
  34, // $89
  35, // $8A
  32, // $8B
  33, // $8C
  38, // $8D
  39, // $8E
  36, // $8F
  37, // $90
 218, // $91
 219, // $92
 216, // $93
 217, // $94
 222, // $95
 223, // $96
 220, // $97
 221, // $98
 210, // $99
 211, // $9A
 208, // $9B
 209, // $9C
 214, // $9D
 215, // $9E
 212, // $9F
 213, // $A0
 202, // $A1
 203, // $A2
 200, // $A3
 201, // $A4
 206, // $A5
 207, // $A6
 204, // $A7
 209, // $A8
 194, // $A9
 195, // $AA
 192, // $AB
 193, // $AC
 198, // $AD
 199, // $AE
 196, // $AF
 197, // $B0
 250, // $B1
 251, // $B2
 248, // $B3
 249, // $B4
 254, // $B5
 255, // $B6
 252, // $B7
 253, // $B8
 242, // $B9
 243, // $BA
 240, // $BB
 241, // $BC
 246, // $BD
 247, // $BE
 244, // $BF
 245, // $C0
 234, // $C1
 235, // $C2
 232, // $C3
 233, // $C4
 238, // $C5
 239, // $C6
 236, // $C7
 237, // $C8
 226, // $C9
 227, // $CA
 224, // $CB
 225, // $CC
 230, // $CD
 231, // $CE
 228, // $CF
 229, // $D0
 154, // $D1
 155, // $D2
 152, // $D3
 153, // $D4
 158, // $D5
 159, // $D6
 156, // $D7
 157, // $D8
 146, // $D9
 147, // $DA
 144, // $DB
 145, // $DC
 150, // $DD
 151, // $DE
 148, // $DF
 149, // $E0
 138, // $E1
 139, // $E2
 136, // $E3
 137, // $E4
 142, // $E5
 143, // $E6
 140, // $E7
 141, // $E8
 130, // $E9
 131, // $EA
 128, // $EB
 129, // $EC
 134, // $ED
 135, // $EE
 132, // $EF
 133, // $F0
 186, // $F1
 187, // $F2
 184, // $F3
 185, // $F4
 190, // $F5
 191, // $F6
 188, // $F7
 189, // $F8
 178, // $F9
 179, // $FA
 176, // $FB
 177, // $FC
 182, // $FD
 183, // $FE
 180  // $FF
};

/* 7. MODULE STRUCTURES --------------------------------------------------

(none)

8. CODE --------------------------------------------------------------- */

EXPORT void q2_main(void)
{   TRANSIENT int                     i;
    TRANSIENT struct ListBrowserNode* ListBrowserNodePtr;
    PERSIST   FLAG                    first = TRUE;

    if (first)
    {   first = FALSE;

        // q2_preinit()
        NewList(&MountList);
        NewList(&RankList);
        NewList(&ItemsList1);
        NewList(&ItemsList2);

        // q2_init()
        lb_makelist(&ItemsList1, ItemNames1, ITEMS);
        for (i = 0; i < 44; i++)
        {   if (!(ListBrowserNodePtr = (struct ListBrowserNode*) AllocListBrowserNode
            (   1,                   // columns,
                LBNA_CheckBox,       TRUE,
                LBNCA_CopyText,      TRUE,
                LBNCA_Text,          ItemNames2[i],
                TAG_END
            )))
            {   rq("Can't create listbrowser.gadget node(s) (out of memory?)!");
            }
            AddTail(&ItemsList2, (struct Node*) ListBrowserNodePtr); // AddTail() has no return code
    }   }

    tool_open  = q2_open;
    tool_loop  = q2_loop;
    tool_save  = q2_save;
    tool_close = q2_close;
    tool_exit  = q2_exit;

    if (loaded != FUNC_Q2 && !q2_open(TRUE))
    {   function = page = FUNC_MENU;
        return;
    } // implied else
    loaded = FUNC_Q2;

    q2_getpens();
    ch_load_images(57, 62, MountOptions, &MountList);
    ch_load_images(63, 68, RankOptions, &RankList);
    make_speedbar_list(GID_Q2_SB1);
    load_aiss_images( 6,  8);
    load_aiss_images(10, 10);

    InitHook(&ToolHookStruct, (ULONG (*)())ToolHookFunc, NULL);
    lockscreen();

    if (!(WinObject =
    NewToolWindow,
        WA_SizeGadget,                                     TRUE,
        WA_ThinSizeGadget,                                 TRUE,
        WINDOW_Position,                                   WPOS_CENTERMOUSE,
        WINDOW_ParentGroup,                                gadgets[GID_Q2_LY1] = (struct Gadget*)
        VLayoutObject,
            LAYOUT_SpaceOuter,                             TRUE,
            LAYOUT_SpaceInner,                             TRUE,
            AddToolbar(GID_Q2_SB1),
            AddHLayout,
                AddVLayout,
                    AddVLayout,
                        LAYOUT_BevelStyle,                 BVS_SBAR_VERT,
                        LAYOUT_SpaceOuter,                 TRUE,
                        LAYOUT_Label,                      "General",
                        LAYOUT_AddChild,                   gadgets[GID_Q2_ST1] = (struct Gadget*)
                        StringObject,
                            GA_ID,                         GID_Q2_ST1,
                            GA_TabCycle,                   TRUE,
                            STRINGA_TextVal,               name,
                            STRINGA_MaxChars,              14 + 1,
                        StringEnd,
                        Label("Name:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN1] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN1,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               65535,
                            INTEGER_MinVisible,            5 + 1,
                        IntegerEnd,
                        Label("Hit Points:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN2] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN2,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               65535,
                            INTEGER_MinVisible,            5 + 1,
                        IntegerEnd,
                        Label("Food:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN3] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN3,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               65535,
                            INTEGER_MinVisible,            5 + 1,
                        IntegerEnd,
                        Label("Gold:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN4] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN4,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               65535,
                            INTEGER_MinVisible,            5 + 1,
                        IntegerEnd,
                        Label("Time:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_CH4] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                         GID_Q2_CH4,
                            CHOOSER_LabelArray,            &ArmourOptions,
                        PopUpEnd,
                        Label("Worn Armour:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_CH3] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                         GID_Q2_CH3,
                            CHOOSER_LabelArray,            &WeaponOptions,
                            CHOOSER_MaxLabels,             15,
                        PopUpEnd,
                        Label("Armed Weapon:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_CH1] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                         GID_Q2_CH1,
                            CHOOSER_Labels,                &RankList,
                            CHOOSER_AutoFit,               TRUE,
                        PopUpEnd,
                        Label("Rank:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_CH2] = (struct Gadget*)
                        PopUpObject,
                            GA_ID,                         GID_Q2_CH2,
                            CHOOSER_Labels,                &MountList,
                            CHOOSER_AutoFit,               TRUE,
                        PopUpEnd,
                        Label("Mount:"),
                    LayoutEnd,
                    CHILD_WeightedHeight,                  0,
                    AddVLayout,
                        LAYOUT_BevelStyle,                 BVS_SBAR_VERT,
                        LAYOUT_Label,                      "Location",
                        LAYOUT_SpaceOuter,                 TRUE,
                        AddHLayout,
                            AddSpace,
                            LAYOUT_AddChild,               gadgets[GID_Q2_SP1] = (struct Gadget*)
                            SpaceObject,
                                GA_ID,                     GID_Q2_SP1,
                                SPACE_MinWidth,            SCALEDWIDTH,
                                SPACE_MinHeight,           SCALEDHEIGHT,
                                SPACE_BevelStyle,          BVS_FIELD,
                                SPACE_Transparent,         TRUE,
                            SpaceEnd,
                            CHILD_WeightedWidth,           0,
                            AddSpace,
                        LayoutEnd,
                        CHILD_WeightedHeight,              0,
                        AddVLayout,
                            LAYOUT_SpaceOuter,             TRUE,
                            LAYOUT_AddChild,               gadgets[GID_Q2_CH5] = (struct Gadget*)
                            PopUpObject,
                                GA_ID,                     GID_Q2_CH5,
                                GA_RelVerify,              TRUE,
                                CHOOSER_LabelArray,        &RealmOptions,
                            PopUpEnd,
                            Label("Realm:"),
                            AddHLayout,
                                LAYOUT_VertAlignment,      LALIGN_CENTER,
                                LAYOUT_AddChild,           gadgets[GID_Q2_IN5] = (struct Gadget*)
                                IntegerObject,
                                    GA_ID,                 GID_Q2_IN5,
                                    GA_TabCycle,           TRUE,
                                    GA_RelVerify,          TRUE,
                                    INTEGER_Minimum,       -30,
                                    INTEGER_Maximum,       120,
                                    INTEGER_MinVisible,    3 + 1,
                                IntegerEnd,
                                AddLabel("Y:"),
                                CHILD_WeightedWidth,       0,
                                LAYOUT_AddChild,           gadgets[GID_Q2_IN6] = (struct Gadget*)
                                IntegerObject,
                                    GA_ID,                 GID_Q2_IN6,
                                    GA_TabCycle,           TRUE,
                                    GA_RelVerify,          TRUE,
                                    INTEGER_Minimum,       -30,
                                    INTEGER_Maximum,       120,
                                    INTEGER_MinVisible,    3 + 1,
                                IntegerEnd,
                            LayoutEnd,
                            Label("X:"),
                            LAYOUT_AddChild,               gadgets[GID_Q2_ST2] = (struct Gadget*)
                            StringObject,
                                GA_ID,                     GID_Q2_ST2,
                                GA_ReadOnly,               TRUE,
                                STRINGA_TextVal,           "-",
                                STRINGA_MaxChars,          22 + 1,
                            StringEnd,
                            Label("Contents:"),
                        LayoutEnd,
                    LayoutEnd,
                LayoutEnd,
                AddVLayout,
                    LAYOUT_BevelStyle,                     BVS_GROUP,
                    LAYOUT_SpaceOuter,                     TRUE,
                    LAYOUT_Label,                          "Items",
                    LAYOUT_AddChild,                       gadgets[GID_Q2_LB2] = (struct Gadget*)
                    ListBrowserObject,
                        GA_ID,                             GID_Q2_LB2,
                        LISTBROWSER_Labels,                (ULONG) &ItemsList2,
                        LISTBROWSER_ShowSelected,          TRUE,
                        LISTBROWSER_AutoWheel,             FALSE,
                    ListBrowserEnd,
                    CHILD_WeightedHeight,                  100,
                    HTripleButton(GID_Q2_BU3, GID_Q2_BU1, GID_Q2_BU4),
                LayoutEnd,
                AddVLayout,
                    AddVLayout,
                        LAYOUT_BevelStyle,                 BVS_SBAR_VERT,
                        LAYOUT_SpaceOuter,                 TRUE,
                        LAYOUT_Label,                      "Attributes",
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN7] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN7,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Charisma:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN8] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN8,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Strength:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN9] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN9,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Agility:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN10] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN10,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Stamina:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN11] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN11,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Intelligence:"),
                    LayoutEnd,
                    CHILD_WeightedHeight,                  0,
                    AddVLayout,
                        LAYOUT_BevelStyle,                 BVS_SBAR_VERT,
                        LAYOUT_SpaceOuter,                 TRUE,
                        LAYOUT_Label,                      "Item in Use",
                        LAYOUT_AddChild,                   gadgets[GID_Q2_LB1] = (struct Gadget*)
                        ListBrowserObject,
                            GA_ID,                         GID_Q2_LB1,
                            LISTBROWSER_Labels,            (ULONG) &ItemsList1,
                            LISTBROWSER_ShowSelected,      TRUE,
                            LISTBROWSER_AutoWheel,         FALSE,
                        ListBrowserEnd,
                    LayoutEnd,
                    AddVLayout,
                        LAYOUT_BevelStyle,                 BVS_SBAR_VERT,
                        LAYOUT_Label,                      "Magic",
                        LAYOUT_SpaceOuter,                 TRUE,
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN12] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN12,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Magic Missile:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN13] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN13,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Fireball:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN14] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN14,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Sonic Whine:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN15] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN15,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Time Sap:"),
                        LAYOUT_AddChild,                   gadgets[GID_Q2_IN16] = (struct Gadget*)
                        IntegerObject,
                            GA_ID,                         GID_Q2_IN16,
                            GA_TabCycle,                   TRUE,
                            INTEGER_Minimum,               0,
                            INTEGER_Maximum,               255,
                            INTEGER_MinVisible,            3 + 1,
                        IntegerEnd,
                        Label("Bread of Life:"),
                    LayoutEnd,
                    CHILD_WeightedHeight,                  0,
                LayoutEnd,
            LayoutEnd,
            MaximizeButton(GID_Q2_BU2, "Maximize Character"),
            CHILD_WeightedHeight,                          0,
        LayoutEnd,
        CHILD_NominalSize,                                 TRUE,
    WindowEnd))
    {   rq("Can't create gadgets!");
    }
    unlockscreen();
    openwindow(GID_Q2_SB1);

    setup_bm(0, SCALEDWIDTH, SCALEDHEIGHT, MainWindowPtr);

    // q2_drawmap();
    westwood();
    writegadgets();
    DISCARD ActivateLayoutGadget(gadgets[GID_Q2_LY1], MainWindowPtr, NULL, (Object) gadgets[GID_Q2_ST1]);
    loop();
    readgadgets();
    closewindow();
}

EXPORT void q2_loop(ULONG gid, UNUSED ULONG code)
{   int i;

    switch (gid)
    {
    case GID_Q2_BU1:
        readgadgets();
        for (i = 0; i < 44; i++)
        {   if (item[i])
            {   item[i] = FALSE;
            } else
            {   item[i] = TRUE;
        }   }
        writegadgets();
    acase GID_Q2_BU2:
        readgadgets();
        maximize_man();
        writegadgets();
    acase GID_Q2_BU3:
        readgadgets();
        for (i = 0; i < 44; i++)
        {   item[i] = TRUE;
        }
        writegadgets();
    acase GID_Q2_BU4:
        readgadgets();
        for (i = 0; i < 44; i++)
        {   item[i] = FALSE;
        }
        writegadgets();
    acase GID_Q2_IN5:
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_Q2_IN5], (ULONG*) &location_x);
        q2_drawmap();
    acase GID_Q2_IN6:
        DISCARD GetAttr(INTEGER_Number,   (Object*) gadgets[GID_Q2_IN6], (ULONG*) &location_y);
        q2_drawmap();
    acase GID_Q2_CH5:
        DISCARD GetAttr(CHOOSER_Selected, (Object*) gadgets[GID_Q2_CH5], &realm);
        q2_drawmap();
}   }

EXPORT FLAG q2_open(FLAG loadas)
{   int   i, j;
    SBYTE temp;

    if (gameopen(loadas))
    {   offset = 0;

        hp    = getcryptword();         //  0.. 1
        food  = getcryptword();         //  2.. 3
        gp    = getcryptword();         //  4.. 5
        offset++;                       //  6
        cha   = getcryptbyte();         //  7
        str   = getcryptbyte();         //  8
        agi   = getcryptbyte();         //  9
        sta   = getcryptbyte();         // 10
        iq    = getcryptbyte();         // 11
        armed = getcryptbyte();         // 12
        worn  = getcryptbyte();         // 13
        mount = getcryptbyte();         // 14
        realm = getcryptbyte();         // 15
        temp  = (SBYTE) getcryptbyte(); // 16
        location_x   = (LONG) temp;
        temp  = (SBYTE) getcryptbyte(); // 17
        location_y   = (LONG) temp;
        offset++;                       // 18
        magicmissile = getcryptbyte();  // 19
        fireball     = getcryptbyte();  // 20
        sonicwhine   = getcryptbyte();  // 21
        timesap      = getcryptbyte();  // 22
        offset++;                           // 23
        j = 0;
        for (i = 0; i <= 13; i++)
        {   item[j++] = getcryptbyte(); // 24..37
        }
        offset++;                       // 38
        for (i = 0; i <= 6; i++)
        {   item[j++] = getcryptbyte(); // 39..45
        }
        offset++;                       // 46
        for (i = 0; i <= 22; i++)
        {   item[j++] = getcryptbyte(); // 47..69
        }
        breadoflife  = getcryptbyte();  // 70
        offset += 5;                    // 71..75
        rank         = getcryptbyte();  // 76
        offset += 3;                    // 77..79
        for (i = 0; i <= 14; i++)
        {   name[i] = getcryptbyte();   // 80..94
        }
        offset += 4;                    // 95..98
        time      = getcryptword();     // 99..100
        iteminuse = getcryptbyte();     // 101
        if (iteminuse > 23)
        {   iteminuse = 23;
        }

        writegadgets();

        return TRUE;
    } // implied else
    return FALSE;
}

MODULE void writegadgets(void)
{   if
    (   page != FUNC_Q2
     || !MainWindowPtr
    )
    {   return;
    } // implied else

    gadmode = SERIALIZE_WRITE;
    eithergadgets();
    q2_drawmap();
}

MODULE void eithergadgets(void)
{   ULONG        i;
    struct Node* NodePtr;
    struct List* ListPtr;

    if (gadmode == SERIALIZE_READ)
    {   DISCARD GetAttr(LISTBROWSER_Selected, (Object*) gadgets[GID_Q2_LB1], (ULONG*) &iteminuse);

        ListPtr = getlist(GID_Q2_LB2);
        i = 0;
        for
        (   NodePtr = ListPtr->lh_Head;
            NodePtr->ln_Succ;
            NodePtr = NodePtr->ln_Succ
        )
        {   DISCARD GetListBrowserNodeAttrs(NodePtr, LBNA_Checked, (ULONG*) &item[i]);
            i++;
    }   }
    else
    {   // assert(gadmode == SERIALIZE_WRITE);

        lb_select(GID_Q2_LB1, iteminuse);

        // items list
        ListPtr = getlist(GID_Q2_LB2);
        detach(GID_Q2_LB2);
        i = 0;
        for
        (   NodePtr = ListPtr->lh_Head;
            NodePtr->ln_Succ;
            NodePtr = NodePtr->ln_Succ
        )
        {   DISCARD SetListBrowserNodeAttrs(NodePtr, LBNA_Checked, (BOOL) item[i], TAG_END);
            i++;
        }
        reattach(GID_Q2_LB2, ListPtr);
    }

    either_st(GID_Q2_ST1,   name        );
    either_ch(GID_Q2_CH1,  &rank        );
    either_ch(GID_Q2_CH2,  &mount       );
    either_ch(GID_Q2_CH3,  &armed       );
    either_ch(GID_Q2_CH4,  &worn        );
    either_ch(GID_Q2_CH5,  &realm       );
    either_in(GID_Q2_IN1,  &hp          );
    either_in(GID_Q2_IN2,  &food        );
    either_in(GID_Q2_IN3,  &gp          );
    either_in(GID_Q2_IN4,  &time        );
    either_in(GID_Q2_IN5,  (ULONG*) &location_x);
    either_in(GID_Q2_IN6,  (ULONG*) &location_y);
    either_in(GID_Q2_IN7,  &cha         );
    either_in(GID_Q2_IN8,  &str         );
    either_in(GID_Q2_IN9,  &agi         );
    either_in(GID_Q2_IN10, &sta         );
    either_in(GID_Q2_IN11, &iq          );
    either_in(GID_Q2_IN12, &magicmissile);
    either_in(GID_Q2_IN13, &fireball    );
    either_in(GID_Q2_IN14, &sonicwhine  );
    either_in(GID_Q2_IN15, &timesap     );
    either_in(GID_Q2_IN16, &breadoflife );
}

MODULE void readgadgets(void)
{   gadmode = SERIALIZE_READ;
    eithergadgets();
}

EXPORT void q2_save(FLAG saveas)
{   ULONG  a,
           i, j;
    BPTR   FileHandle /* = ZERO */ ;
    TEXT   NamesBuffer[144],
           namespathname[MAX_PATH + 1];
    STRPTR filename;

    readgadgets();

    IOBuffer[  0] = theencrypt(hp     / 256);
    IOBuffer[  1] = theencrypt(hp     % 256);
    IOBuffer[  2] = theencrypt(food   / 256);
    IOBuffer[  3] = theencrypt(food   % 256);
    IOBuffer[  4] = theencrypt(gp     / 256);
    IOBuffer[  5] = theencrypt(gp     % 256);
    IOBuffer[  7] = theencrypt(cha         );
    IOBuffer[  8] = theencrypt(str         );
    IOBuffer[  9] = theencrypt(agi         );
    IOBuffer[ 10] = theencrypt(sta         );
    IOBuffer[ 11] = theencrypt(iq          );
    IOBuffer[ 12] = theencrypt(armed       );
    IOBuffer[ 13] = theencrypt(worn        );
    IOBuffer[ 14] = theencrypt(mount       );
    IOBuffer[ 15] = theencrypt(realm       );
    IOBuffer[ 16] = theencrypt((UBYTE) location_x);
    IOBuffer[ 17] = theencrypt((UBYTE) location_y);
    IOBuffer[ 19] = theencrypt(magicmissile);
    IOBuffer[ 20] = theencrypt(fireball    );
    IOBuffer[ 21] = theencrypt(sonicwhine  );
    IOBuffer[ 22] = theencrypt(timesap     );

    j = 0;
    for (i = 0; i <= 13; i++)
    {   if (item[j])
        {   item[j] = 1;
        }
        IOBuffer[24 + i] = theencrypt(item[j++]); // 24..37
    }
    for (i = 0; i <= 6; i++)
    {   if (item[j])
        {   item[j] = 1;
        }
        IOBuffer[39 + i] = theencrypt(item[j++]); // 39..45
    }
    for (i = 0; i <= 22; i++)
    {   if (item[j])
        {   item[j] = 1;
        }
        IOBuffer[47 + i] = theencrypt(item[j++]); // 47..69
    }
    IOBuffer[70] = theencrypt(breadoflife);
    IOBuffer[76] = theencrypt(rank);
    if (strlen(name) < 14)
    {   for (i = strlen(name); i <= 13; i++)
        {  name[i] = EOS;
    }   }
    for (i = 0; i <= 14; i++)
    {   IOBuffer[80 + i] = theencrypt(name[i]); // 80..94
    }
    IOBuffer[ 99] = theencrypt(time / 256);
    IOBuffer[100] = theencrypt(time % 256);
    if (iteminuse >= 23)
    {   iteminuse = 255;
    }
    IOBuffer[101] = theencrypt(iteminuse);
    if (iteminuse == 255)
    {   iteminuse = 23;
    }

    gamesize = 255;
    if (!gamesave("G?", "Questron 2", saveas, 255, FLAG_S, TRUE))
    {   return;
    }

    zstrncpy(namespathname, pathname, (size_t) ((STRPTR) PathPart(pathname) - (STRPTR) pathname));
    if (!AddPart(namespathname, "NAMES", MAX_PATH))
    {   printf("Error 1 on file %s!\n", namespathname);
        return;
    }
    if (!(FileHandle = (BPTR) Open(namespathname, MODE_OLDFILE)))
    {   printf("Error 2 on file %s!\n", namespathname);
        return;
    }
    if (Read(FileHandle, NamesBuffer, (LONG) 144) != 144)
    {   DISCARD Close(FileHandle);
        // FileHandle = ZERO;
        printf("Error 3 on file %s!\n", namespathname);
        return;
    }
    DISCARD Close(FileHandle);
    // FileHandle = ZERO;
    filename = (STRPTR) FilePart(pathname);
    if (filename[1] < '0' || filename[2] > '7')
    {   printf("Error 4 on file %s!\n", namespathname);
        return;
    }
    a = 3 + ((filename[1] - '0') * 18);
    for (i = 0; i <= 14; i++)
    {   NamesBuffer[a + i] = name[i];
    }
    if (!(FileHandle = (BPTR) Open(namespathname, MODE_NEWFILE)))
    {   printf("Error 5 on file %s!\n", namespathname);
        return;
    }
    DISCARD Write(FileHandle, NamesBuffer, 144);
    DISCARD Close(FileHandle);
    // FileHandle = ZERO;

    say("Saved files.", REQIMAGE_INFO);
}

EXPORT void q2_exit(void)
{   ch_clearlist(&MountList);
    ch_clearlist(&RankList);
}

EXPORT void q2_die(void)
{   lb_clearlist(&ItemsList1);
    lb_clearlist(&ItemsList2);
}

EXPORT void q2_close(void) { ; }

MODULE void maximize_man(void)
{   int i;

    hp           =
    food         =
    gp           = 65000;
    cha          =
    str          =
    agi          =
    sta          =
    iq           =   250;
    magicmissile =
    fireball     =
    sonicwhine   =
    timesap      =
    breadoflife  =   250;
    rank         =     4;
    mount        =     1;
    armed        =    13;
    worn         =     7;
    for (i = 0; i < 44; i++)
    {   item[i] = TRUE;
}   }

MODULE UBYTE getcryptbyte(void)
{   UBYTE value;

    value = thedecrypt[IOBuffer[offset]];
    offset++;
    return value;
}
MODULE UWORD getcryptword(void)
{   UWORD value;

    value = (thedecrypt[IOBuffer[offset    ]] * 256) +
             thedecrypt[IOBuffer[offset + 1]];
    offset += 2;
    return value;
}
MODULE UBYTE theencrypt(UBYTE input)
{   int i;

    for (i = 0; i <= 255; i++)
    {   if (thedecrypt[i] == input)
        {   return (UBYTE) i;
    }   }

    // assert(0);
    return 0;
}

EXPORT void q2_getpens(void)
{   lockscreen();
    pens[LIGHTGREEN] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x00000000, 0xFFFFFFFF, 0x00000000, -1);
    pens[BLUE      ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x00000000, 0x00000000, 0xFFFFFFFF, -1);
    pens[RED       ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0x00000000, 0x00000000, -1);
    pens[DARKGREEN ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x00000000, 0x88888888, 0x00000000, -1);
    pens[ORANGE    ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0x88888888, 0x00000000, -1);
    pens[GREY      ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0x88888888, 0x88888888, 0x88888888, -1);
    pens[WHITE     ] = FindColor(ScreenPtr->ViewPort.ColorMap, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, -1);
    unlockscreen();
}

EXPORT void q2_drawmap(void)
{   TRANSIENT int    x, y;
    PERSIST   STRPTR desc;

    for (y = 0; y < MAPHEIGHT; y++)
    {   for (x = 0; x < MAPWIDTH; x++)
        {   switch (q2_map[realm][y][x])
            {
            case  '#': drawpoint(x, y, LIGHTGREEN);
            acase '-': drawpoint(x, y, BLUE);
            acase '%': drawpoint(x, y, RED);
            acase '!': drawpoint(x, y, DARKGREEN);
            acase '^': drawpoint(x, y, ORANGE);
            acase '$': drawpoint(x, y, GREY);
    }   }   }

    if (location_x >= 0 && location_x < MAPWIDTH && location_y >= 0 && location_y < MAPHEIGHT)
    {   for (x = 0; x < MAPWIDTH; x++)
        {   if (x != location_x)
            {   drawpoint(x, location_y, WHITE);
        }   }
        for (y = 0; y < MAPHEIGHT; y++)
        {   if (y != location_y)
            {   drawpoint(location_x, y, WHITE);
    }   }   }

    DISCARD WritePixelArray8
    (   MainWindowPtr->RPort,
        gadgets[GID_Q2_SP1]->LeftEdge,
        gadgets[GID_Q2_SP1]->TopEdge,
        gadgets[GID_Q2_SP1]->LeftEdge + SCALEDWIDTH  - 1,
        gadgets[GID_Q2_SP1]->TopEdge  + SCALEDHEIGHT - 1,
        display1,
        &wpa8rastport[0]
    );

    switch (q2_map[realm][location_y][location_x])
    {
    case  '#': desc = "Plains";
    acase '-': desc = "Sea";
    acase '%': desc = specialdesc(location_x, location_y, realm);
    acase '!': desc = "Forest";
    acase '^': desc = "Mountains";
    acase '$': desc = "Swamp";
    }
    DISCARD SetGadgetAttrs
    (   gadgets[GID_Q2_ST2],
        MainWindowPtr, NULL,
        STRINGA_TextVal, desc,
    TAG_END);
}

#define DESCS 27
MODULE STRPTR specialdesc(int x, int y, int realm)
{   TRANSIENT int i;
    PERSIST   struct
    {   int    x, y,
               realm,
               xsize, ysize;
        STRPTR desc;
    } specialdescs[DESCS] = {
{  9,  3, 0, 2, 1, "Octapoint"              },
{ 51,  8, 0, 2, 2, "Great Plains Cathedral" },
{ 74,  9, 0, 2, 1, "Hidden Rock"            },
{ 11, 12, 0, 2, 2, "Rivercrest Cathedral"   },
{ 33, 15, 0, 2, 1, "Cramford"               },
{ 22, 35, 0, 2, 1, "Seacrest"               },
{ 53, 36, 0, 2, 1, "Bay View"               },
{ 71, 42, 0, 2, 1, "Folman"                 },
{ 33, 44, 0, 2, 1, "Long View"              },
{ 24, 52, 0, 2, 1, "Lyton"                  },
{ 66, 53, 0, 2, 1, "Ontaga"                 },
{ 59, 59, 0, 2, 2, "Sanctuary Cathedral"    },
{ 67, 72, 0, 2, 1, "Crooked Pine"           },
{ 16, 73, 0, 2, 2, "Castle Redstone"        },
{ 48, 79, 0, 2, 1, "Santor"                 },
{ 55,  6, 1, 2, 1, "Lookout Point"          },
{ 20,  9, 1, 2, 1, "Burnside"               },
{  7, 10, 1, 2, 2, "Twilight Cathedral"     },
{ 57, 23, 1, 2, 1, "Big Oak"                },
{ 10, 34, 1, 2, 1, "Brantown"               },
{ 78, 35, 1, 2, 1, "Slippery Rock"          },
{ 84, 45, 1, 3, 1, "Dungeon"                },
{ 39, 46, 1, 3, 1, "Dungeon of Despair"     },
{ 48, 47, 1, 2, 1, "Demph"                  },
{  6, 57, 1, 2, 1, "Castle Kelfar"          },
{ 67, 66, 1, 2, 1, "Grissold"               },
{ 13, 86, 1, 2, 1, "Orchard Lake"           }
};

    for (i = 0; i < DESCS; i++)
    {   if
        (   x     >= specialdescs[i].x
         && x     <  specialdescs[i].x + specialdescs[i].xsize
         && y     >= specialdescs[i].y
         && y     <  specialdescs[i].y + specialdescs[i].ysize
         && realm == specialdescs[i].realm
        )
        {   return specialdescs[i].desc;
    }   }

    return "?"; // should never happen
}

MODULE void drawpoint(int x, int y, int colour)
{   int xx, yy;

    for (yy = 0; yy < MAPSCALE; yy++)
    {   for (xx = 0; xx < MAPSCALE; xx++)
        {   *(byteptr1[(y * MAPSCALE) + yy] + (x * MAPSCALE) + xx) = pens[colour];
}   }   }

EXPORT void q2_uniconify(void)
{   q2_getpens();
    q2_drawmap();
}

EXPORT void q2_lmb(SWORD mousex, SWORD mousey)
{   if
    (   mousex < gadgets[GID_Q2_SP1]->LeftEdge
     || mousey < gadgets[GID_Q2_SP1]->TopEdge
     || mousex > gadgets[GID_Q2_SP1]->LeftEdge + SCALEDWIDTH  - 1
     || mousey > gadgets[GID_Q2_SP1]->TopEdge  + SCALEDHEIGHT - 1
    )
    {   return;
    }

    location_x = (mousex - gadgets[GID_Q2_SP1]->LeftEdge) / MAPSCALE;
    location_y = (mousey - gadgets[GID_Q2_SP1]->TopEdge ) / MAPSCALE;

    DISCARD SetGadgetAttrs
    (   gadgets[GID_Q2_IN5], MainWindowPtr, NULL,
        INTEGER_Number, location_x,
    TAG_END); // this autorefreshes
    DISCARD SetGadgetAttrs
    (   gadgets[GID_Q2_IN6], MainWindowPtr, NULL,
        INTEGER_Number, location_y,
    TAG_END); // this autorefreshes

    q2_drawmap();
}

EXPORT void q2_key(UBYTE scancode, UWORD qual, SWORD mousex, SWORD mousey)
{   int temp;

    switch (scancode)
    {
    case SCAN_LEFT:
    case SCAN_N4:
        temp = location_x + 30;
        map_leftorup(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;
        q2_drawmap();
    acase SCAN_RIGHT:
    case SCAN_N6:
        temp = location_x + 30;
        map_rightordown(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;
        q2_drawmap();
    acase SCAN_UP:
    case SCAN_N8:
    case NM_WHEEL_UP:
        if (mouseisover(GID_Q2_SP1, mousex, mousey))
        {   temp = location_y + 30;
            map_leftorup(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
            location_y = temp - 30;
            q2_drawmap();
        } elif (mouseisover(GID_Q2_LB1, mousex, mousey))
        {   lb_move_up(GID_Q2_LB1, MainWindowPtr, qual, &iteminuse, 0, 5);
        } else
        {   lb_scroll_up(GID_Q2_LB2, MainWindowPtr, qual);
        }
    acase SCAN_DOWN:
    case SCAN_N5:
    case SCAN_N2:
    case NM_WHEEL_DOWN:
        if (mouseisover(GID_Q2_SP1, mousex, mousey))
        {   temp = location_y + 30;
            map_rightordown(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
            location_y = temp - 30;
            q2_drawmap();
        } elif (mouseisover(GID_Q2_LB1, mousex, mousey))
        {   lb_move_down(GID_Q2_LB1, MainWindowPtr, qual, &iteminuse, ITEMS - 1, 5);
        } else
        {   lb_scroll_down(GID_Q2_LB2, MainWindowPtr, qual);
        }
    acase SCAN_N1:
        temp = location_x + 30;
        map_leftorup(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;

        temp = location_y + 30;
        map_rightordown(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
        location_y = temp - 30;

        q2_drawmap();
    acase SCAN_N3:
        temp = location_x + 30;
        map_rightordown(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;

        temp = location_y + 30;
        map_rightordown(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
        location_y = temp - 30;

        q2_drawmap();
    acase SCAN_N7:
        temp = location_x + 30;
        map_leftorup(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;

        temp = location_y + 30;
        map_leftorup(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
        location_y = temp - 30;

        q2_drawmap();
    acase SCAN_N9:
        temp = location_x + 30;
        map_rightordown(qual, 150, &temp, GID_Q2_IN5, MainWindowPtr);
        location_x = temp - 30;

        temp = location_y + 30;
        map_leftorup(qual, 150, &temp, GID_Q2_IN6, MainWindowPtr);
        location_y = temp - 30;

        q2_drawmap();
}   }

EXPORT void q2_tick(SWORD mousex, SWORD mousey)
{   if (mouseisover(GID_Q2_SP1, mousex, mousey))
    {   setpointer(TRUE , WinObject, MainWindowPtr, FALSE);
    } else
    {   setpointer(FALSE, WinObject, MainWindowPtr, FALSE);
}   }
