
                              à--â _____________
                   __/\__   __Ä__Ä_õ___ú\__ ___/ __/\__
                   \ ∑. /  /Ø_____/¶  ¨¶  |  T   \ ∑. /
                   å_--_ç /  \/  | |   |  |  |   å_--_ç
                     \/   \______è é___è  é__è     \/

                                 PRESENTS

                            Ami-FileSafe V2.2

          The New de facto Standard Filing System for the Amiga

                               User Manual

                The Professional File System for the Amiga

                     Typed and Edited By DIT 12-10-95

 1. Copyright

 2. Introduction
    A. Amiga Filing Systems
    B. AFS - The New de facto standard and it history
    C. V2.01 Basic Features
    D. DiskSalv support
    E. Floppy/Harddisk
    F. Future Releases and UpDates
    G. Performance

 3. System Requirements

 4. Floppy Installation
    A. Workbench 2.0
    B. Workbench 3.0/3.1

 5. Using Ami-FileSafe on floppy disks
    A. Formatting Floppy Disks
    B. Accessing disks

 6. Installing Ami-FileSafe on harddisks
    A. Restrictions and requirements
    B. Preparing installation
    C. Making and changing mount list entries
    D. Installing Ami-FileSafe on the rigid disk blocks
    E. Installing Ami-FileSafe onto a partition
    F. Installing Updates

 7. Using Ami-FileSafe on Hard Disks

 8. Differences with FFS/OFS
    A. Free Space
    B. Compatibility
    C. Restrictions
    D. Fault tolerance
       i.  OFS & FFS
       ii. AFS
    E. Virus damage and virus killers

 9. Included tools
    A. MFS
    B. Makelink
    C. FFS2AFS Pro
    D. Undelete
    E. RemoveDirEntry

 10. Bugs

 11. Updates

 12. Developers

 13. Registrations

 14. Support


 1. Copyright

The Ami-FileSafe (AFS) Software is the joint copyright of Fourth Level
Developments & Michiel Pelt (1993/1995) the Developers) and distributed by
Fourth Level Developments (the Distributors).

No part of the software or the documentation may be reproduced transcribed
stored in a retrieval system translated into any language or transmitted
in any form without the express written consent of Fourth Level
Developments.

The Developers and Distributors shall not be liable for errors contained
in the software or documentation or for incidental or consequential damage
in connection with the furnishing, performance or use of the software or
documentation.

The Developers and Distributors reserve the right to revise and make
changes to the software and/or documentation from time to time without
obligation to notify any person of such changes.

This software is provided as a single machine licence and one copy of the
software must be purchased for every machine that the software is to
control. It is the purchaser`s responsibility to ensure that copies of
Ami-FileSafe are not made available or copied by third parties. It is
therefore recommended that the original disks are kept in a secure place.
In the event of copies being unlawfully distributed the original purchaser
is responsible under British and European law for any losses or damages
incurred by Fourth level developments.

This software is provided under licence and on the understanding that any
licences for earlier versions and any obligations whether written or
implied under any earlier versions of Ami-FileSafe (AFS) or PFS are
determined under this licence. If you have any problems, comments,
suggestions or queries please get in touch with Fourth Level Development
using one of the contacts given at the end of this manual.

 2. Introduction

A. Amiga Filing Systems

The Standard AmigaDOS filesystem (OFS) has always had problems. There are
two primary difficulties:

 Page 2

(i).  it is slow (on large disks very slow!).
(ii). The filing system has problems if the system crashes whilst writing
      to disk.

Commodore tried to improve the performance of their file system a number
of times. Workbench 2.0 added the Fast File System (FFS), and now, with
Workbench 3.1, we have the Fast File System with directory caching (FFS-
DC). This makes directory scans faster, but writing to disk and directory
operations like delete and rename, are slower than ever.

 B. AFS - The New de facto standard and its history.

These problems have been addressed by Ami-FileSafe along with a large
number of other inefficiencies to produce a new de facto standard filing
system for your Amiga.

The improvements over FFS in both speed and data security are substantial.

Ami-FileSafe (AFS) was originally developed by Michiel Pelt and released
as shareware under the name PFS (professional File System). The need for a
more sophisticated and comprehensive version soon became apparent and this
led to collaboration between Michiel Pelt and Fourth Level Developments,
who are renowned for their work on computer filing systems on magneto-
optical drives with very large directory trees Ami-FileSafe Version 2.01
is the result of that collaboration.

There were a number of bugs in the shareware version which has now been
withdrawn from circulation. Fourth Level Developments and Michiel Pelt
worked together to identify and eradicate all known bugs and to introduce
some new features. This resulted in Ami-FileSafe Version 1.0 which was
then subjected to exhaustive testing. As a result we had a stable platform
for further development to commercial standards.

Fourth Level Developments have a policy of not shipping software until it
has fully matured and Ami-FileSafe V1.0 was therefore not released. We
decided to add a substantial number of additional features which would
make AFS operate reliably with all O/S legal software and which would
provide a complete  filing system capable of being accepted as the new de
facto standard for the Amiga. The result is AFS V2.01

 Page 3

 C. V2.01 Basic Features

The Version 2.01 includes:

    * Notification
    * Hard and soft links
    * Supports large partitions (Up to 2GB)
    * Auto-Booting support
    * AddBuffers support
    * Sophisticated Cache Routines
    * Max transfer and DMA masking
    * Very Large Directory support
    * Setowner support
    * A new FreeBlock Management System
    * International Support

Hundreds of minor fixes and improvements have been made which amount to a
major rewrite of the entire filing system to commercial standards.

 D. DiskSalv support

Ami-FileSafe is supported in Dave Haynie`s latest version of DiskSalv
(release date June/July 1995) which will be distributed by Fourth Level
Developments.

 E. Floppy/Harddisk

Included are a version for floppy and a version for harddisk. It is up to
you to use one of them or both. They don`t interfere with each other and
can be used simultaneously on the same machine.

 F. Future Releases and UpDates

There are many Amiga owners who use the Multi-User Filing System. The
V2.01 filing system incorporates the features essential for MuFS. However
MuFS permissions are not enforced in V2.01 but will be in Version 2.1. All
purchasers of V2.01 are entitled to the V2.1 upgrade.

Version 2.2 will include comprehensive undelete features (release date
August 1995) and support for partitions up to 9G. Registered users of
V2.01/".1 will be entitled to this upgrade free of charge.

 Page 4

Version 3.00 due in the Autumn of 1995, will provide a significant number
of additional features including memory protection for both the filing
system cache and for programmes written to take advantage of AFS. This
will fulfil the long expressed requirement of serious Amiga users.

The plans for Version 4.00 include multi-platform and operating system
support, together with variable read/write access modes to enable
developers to select the mode which best supports the requirements of
their applications. Detailed information for developers is due for release
in August/September 1995.

 G. Performance

Ami-FileSafe has the following performance characteristics:

High performance:

read and write operations: faster by a factor of 2
directory scan: 10-20 times FFS. 3 times FFS-DC
delete/rename/protect etc: 10-20 times faster

Other features:

full AmigaDOS compatibility
better fault tolerance
parallel access almost without performance loss
disk NEVER get invalidated

This distribution includes a floppy version and a harddisk version. The
floppy version is fully compatible with the previous shareware versions
of PFS. It can be used for both double and high density disks.

The harddisk version supports all hard disks of all brands and sizes. It
is RDB installable and supports booting. It is NOT compatible with
harddisk shareware version of PFS

 3. System Requirements

Ami-FileSafe will work on any Amiga with kickstart 2.04 or higher. For RDB
installed automounting this kickstart has to be in ROM. Versions for both
68000 and 68020+ based systems are provided.

 Page 5

 4. Floppy Installation

 A. Workbench 2.0

First you have to boot from your standard Systemdisk or harddisk. Now
double click on the INSTALL_2.0 (Or INSTALL_2.0_0.20 for 68020+ users)
icon. This script will copy the filesystem to the l: directory of your
system disk and add two entire to your mountlist, AF0: and AF1:

To use the file system with Workbench 2.0 you have to mount it using the
mount command:

MOUNT af0:
MOUNT af1:

AF0: and AF1: now refer to Ami-FileSafe disks in drive 0 and 1. If you
want to have Ami-FileSafe mounted on startup you should add the above
command to your startup-sequence.

 B. Workbench 3.0/3.1

First you have to boot from your standard system disk or harddisk. Now
double click on the INSTALL_3.0 (Or INSTALL_3.0_020+ user) icon. This
script will copy the filesytem to the l: directory of your systemdisk and
put two files in your SYS:Storage/DOSDrivers directory called AF0 and AF1.
Double clicking their icons will mount the filesytem on the corresponding
drive, AF0: and AF1: You can then refer to Ami-FileSafe disks in drive 0
and 1 as AF0: or AF1:. If you want to have Ami-FileSafe automatically
mounted on startup you can move the AF0: and AF1: to your Devs:DOSDrives
directory.

 5. Using Ami-FileSafe on floppy disks

 A. Formatting Floppy Disks

After mounting you can format floppies in Ami-FileSafe format by using the
standard sys:system/format command. To format a disk named "hello" type:

     format drive af0: name hello

 Page 6

If the disk has been formatted, before you can use the quick option, even
if the previous format was FFS or OFS (this works the other way round
too). However, if you do so, you should remove the disk after formatting.

     format drive af0: name hello quick

 B. Accessing disks

 (i) Shell use:

Ami-FileSafe disks can be referred to by diskname (e.g. hello) or by
mountname (e.g. af0: or af1:). All Commodore cli commands work on Ami-
FileSafe  disks like on any other disk but you will get faster results.

 (ii) Workbench use:

When an Ami-FileSafe disk is inserted in drive 0 two icons will appear on
your workbench: one with label DF0:Ami-FileSafe and one with the diskname
as label. The first comes from the standard filesytem, the second from the
Ami-FileSafe filesystem. you can access the disk through the latter icon.
It will behave just like DF0: only faster.

 6. Installing Ami-FileSafe on Harddisks

 A. Restrictions and requirements

The harddisk version of Ami-FileSafe has no limitations on the partition
or harddisk other than those of FFS. Partitions of up to 2 gigabytes are
supported. It can be installed and automounted in the RidgidBootBlock, but
standard mountlists can also be used. Autobooting is supported. Memory
usage depends on the number of buffers selected.

 B. Preparing installation

WARNING - If you are not an experienced user you should consider backing
up your harddisk before proceeding.

If you haven`t already, double-click on one of the install icons. Use
INSTALL_2.0 for Workbench 2.0/2.01 and INSTALL_3.0 for Workbench 3.0/3.1.
If you have a 68020/68030/68040/68060 you should use the INSTALL_2.0_020
or INSTALL 3.0_020 icons instead.

 Page 7

WARNING - If you have a softkicked Amiga such as an A3000 then please read
the SOFTKICK_README file on your install disk.

 C. Making and changing mountlist entries

If you cannot use the RDB for hard disk installation, you can create your
own mountlist entries. Make sure that you set the UNIT correctly. If you
are making a harddisk mountlist entry, double-check all entries before
trying to mount!

Please refer to the DOS manual for more details

 D. Installing Ami-FileSafe on a rigid disk blocks

Now you can install Ami-FileSafe on the RidgidDiskBlock. You can use
Commodore`s HDToolbox, which is supplied with the workbench, for this. If
you use another tool you should refer to its documentation for more
information.

Load HDToolBox and select the hard drive you are using. Click on the
Partition button.

Select Advanced Options in the partitioning window. A number of extra
buttons appear. Click on the Add/Update button.

Type in L:HardDiskAFS as the file name of the filesystem.

Enter 0x41465302 as the dostype.

Leave the version and revision number at the default values.

Now click OK and then OK again to go back to the partitioning window.

 E. Installing Ami-FileSafe onto a partition

Now you need to create a new partition. If you don`t have any free space
then you will need to either:

 a) Re-organise your hard drive so you can delete a partition.
 b) Add a new hard drive.

 Page 8

If you need to quit HDToolBox then save the changes and reboot. When you
have enough space free reload HDToolBox, select the desired drive and
click Partition again. Enable the Advanced Options checkbox and continue
as before.

Click on New Partition and type in the partition device name you require.
Click the Change button (Under Filesytem) and select Ami-FileSafe (AFS/2)
as the filesystem for that partition. Click Ok.

If you want to boot from the new partition then set the bootable flag.

You can now set the number of buffers  that Ami-FileSafe will use for this
partition by typing the number you require into the buffers box. Each
buffer is 1K. Ami-FileSafe works best (is faster) with 200-300 (200-300K).
If you have enough memory free type in 300. If you are short of memory the
enter 100.

WARNING - you should not use less than 50 buffers with Ami-FileSafe.

If you are using a SCSI card which did not come with your Amiga you will
now need to check its manual for reference to maxtransfer and DMA mask. If
you find any instructions about setting these values then follow them. If
there is no reference to the maxtransfer the n use 0xf000.

Click Ok and then Save Changes. Exit HDToolBox and reboot.

Ami-FileSafe should be installed on the new partition now. When you have
re-loaded workbench you can Format the partition by clicking on the icon
(Shows up as NAME:NDOS) and selecting Format from the Workbench menu.

 F. Installing Updates

Ever partition will use the version of Ami-FileSafe you have installed in
the Rigid Disk Blocks. When you install an update you will need to update
Ami-FileSafe on the Rigid Disk Blocks.

After you have clicked on the install icon on your update disk, load up
HDToolBox and select the hard drive you are going to update. Click
partition and then enable the Advanced Options checkbox. Click on
add/update and select Ami-FileSafe (Custom File System - 0x41465302).
Click Update and type in L:HardDiskAFS.

 Page 9

Leave the version and revision numbers at the default. Now press Ok. Click
Ok again, Save Changes, quit and reboot.

 7. Using Ami-FileSave on Hard Disks

Once you have installed Ami-FileSafe you should find it works just like
FFS but faster. You may, however, notice a few minor differences.

 8. Differences with FFS/OFS

 A. Free Space

When you initially format an Ami-FileSafe disk you will find that the
space free on the partition is slightly less than the total partition
size. This is because Ami-FileSafe sets aside some of the partition to
store the file structures.

The info command gives the correct blocks used information. However the
list command gives blocks used information which is too high. This is
because the list command assumes every file consumes a block of free
space to use as a headerblock, but Ami-FileSafe uses blocks much more
efficiently. As a rule of thumb you can say that the real number of blocks
used is the given amount minus the number of files listed.

Directory tools like Directory Opus have some problems with their space
left figure during a copy session. You will notice that after copying is
finished freespace goes up to the correct figure.

This also explains why Ami-FileSafe stores more data than FFS disks; it is
because AFS uses a larger part of the blocks for actual data storage.

 B. Compatibility

All Amiga-Dos features, except record locks, are implemented in Ami-
FileSafe.

Ami-FileSafe floppy disks cannot be made bootable (Hard disk partitions
can), so using the INSTALL command on an Ami-FileSafe floppy disk will
fail.

All OS-Legal programs work with Ami-FileSafe, however, some disktools and
games will not.

 Page 10

If you are using an external disk cache program with Ami-FileSafe then
ensure you disable write cache.

If you are using a virtual memory program such as VMM or GigaMem then do
not try to put your swap file onto a AFS partition. You can use a full
partition or a swap file on an FFS partition however.

 C. Restrictions

Ami-FileSafe has the standard AmigaDOS restrictions on file and disk
naming:

Maximum disknamelength 32
Maximum filenamelength 96
Maximum commentlength  80
Almost unrestricted character use in file names

These restrictions are enforced by AmigaDOS, they are not inherent to the
file system. The number of files in a directory or on a disk is restricted
only by the available diskspace.

 D. Fault tolerance

 (i) OFS & FFS

When you reset or crash your machine on standard OFS or FFS disks during a
write operation the disk usually becomes invalidated. When you insert
that disk later the disk will be revalidated automatically. There are
however a number of drawbacks with the original Commodore method:

It takes a long time to validate (on large disks an unacceptably long
period)
It doesn`t always work (Sometimes the disk goes corrupt)
If you were overwriting a file at the time of the crash you loose both
the original and the new version. The date stamp on both the directory and
the files are not updated and the directory gives misleading information.

 (ii) AFS

With Ami-FileSafe the directory is correct at all times. This means that
whenever you remove the disk, rest or crash the system, all the objects
(files and directories) listed in the directory will be there as stated in
that directory, including the filesize and date.

 Page 11

An Ami-FileSafe disk NEVER gets invalidated. However this does not mean
you cannot lose data under any circumstances.

When you operate on the disk (creating files and directories, deleting
files etc) the file system keeps track of all changes to the directory but
doesn`t write these changes to the disk until the operation is completed.
It does write data, but only to clean areas (diskspace that wasn`t in use
the last time the directory was updated). If you stop writing to the disk
for half a second, the directory is updated so that the area occupied by
deleted files can be reused without invalidating the disk. This means if
your Amiga breaks down at a nasty moment you will probably find the disk
in the state it was before you started your writing session. (A writing
session terminates every time the AFS buffers are updated and when there
is no disk activity for more than half a second.) This includes
overwritten files, which will be back in their old state. To enable this
to happen Ami-FileSafe ensures that at least 5% of the disk is free at all
times.

The directory and allocation tables themselves are also updated in such a
way that the disk cannot become invalidated. So even a crash during the
update won`t invalidate the disk.

An extra advantage of this procedure is that files that are overwritten by
a larger version are not fragmented, as in most filesystems. The file will
be fragmented only when there is not a large enough continuous free
segment available. A fragmented file is even defragmented if possible.

Ami-FileSafe does everything it can to limit freespace-fragmentation and
the directory is frequently updated to assist in this process.

An Ami-FileSafe disk normally cannot get invalidated but it can get
corrupted. Nothing can be done about bad tracks on a disk or external
programs (like viruses or diskeditors) that mess with the disk. A read or
write error makes the disk invalid. In this case you will need a new
version of DiskSalv to repair your Ami-FileSafe disk.

 E. Virus damage and viruskillers

Bootblocks viruses destroy the bootblock of the disk. For this reason Ami-
FileSafe doesn`t store urecoverable data in those blocks. It does use the
bootblock to recognise a disk as being an Ami-FileSafe disk, so it the
bootblock id destroyed, the disk won`t be recognized anymore.

 Page 12

To repair such a disk you simply have to write an Ami-FileSafe bootblock
back to it. You can do that by copying a bootblock from an unaffected disk
to the disk. Most virus killers have functions to do that. Remember not to
change any blocks other than the bootblocks (block 0 and 1).

Most virus killers have no problem with Ami-FileSafe disks. You should
check if your viruskiller accepts uninfected Ami-FileSafe disks as normal.

 9. Included tools

You will find tools that come in handy with Ami-FileSafe in the tools
directory.

 A. MFS

MFS helps you combine several filesystems (Ami-FileSafe, FFS etc) on a
single drive. Please read the instructions with MFS.

 B. Makelink

A new makelink command is included with Ami-FileSafe. It is automatically
installed in your c: directory. It is included to fix a bug (with
softlinks) in the version included with Workbench.

 C. FFS2AFS Converter (PRO)

Included  in  this  version  is  an  FFS2AFS  converter.  This program
will convert your standard Fast File System partitions to Ami-FileSafe
format.

Warning  -  While the converter program makes every attempt to ensure
your data is safe (In the event of a system crash or power loss) you could
under rare circumstances lose data. We therefore suggest you make a backup
of your FFS partition before running the converter.

When you get to section 6E in the installation procedure (in the
manual) you can instead of creating a new partition convert one of your
current FFS partitions to AFS:-

 a)  Choose an FFS (Standard, International or directory cache) partition
     to convert to AFS.

     If  you are using the User version of Ami-FileSafe then you should
     only try to  convert  an  FFS  partition which is on a hard drive
     whose size is less than  650MB.  Do not forget that the user version
     of Ami-FileSafe can only be  used  on  one hard drive, so do not try
     to convert partitions from more than one drive.

     You  now  need  to  ensure  you have at least 10% of the partition
     free. If you  do  not then you will need to either compress, delete #
     or move off some files to free up enough space for the conversion.

 b)  At  this  point  you  may want to re-organize this partition to
     improve performance.   If  you  decide to do this you will need a
     shareware program called  "Reorg".   You should optimize your FFS
     partition with "Free blocks after boot block" selected (From the
     advanced options menu).

 c) Open a shell and type:

    ffs2afs name:

    Where 'name' is the name of an FFS partition that you wish to convert
    to AFS.

    You will asked if you wish to proceed, if you type 'y' then that
    partition will be converted to AFS.

    If the converter program fails due to lack of free space:

    Wait until the FFS partition is validated. Go back and free up some
    more space on that partition before trying again.

    If the conversion finishes successfully:

    Reboot your Amiga.

   The partition you converted should now be useable as normal. You may
   repeat this procedure for other FFS partitions if you wish.

 D. Undelete

AFS now includes an un-delete feature. Located off the root is a
subdirectory called ".deldir". It stores the last 31 deleted files. To
list the currently valid deleted files (from cli) type:

 list :.deldir

You will notice the filenames have a number called a "slot number"
appended after them to prevent duplicate file names.

To undelete a file simply copy it from the .deldir onto another drive
e.g:-

 copy :.deldir/NewsBatch@022 ram:

Will un-delete the NewBatch@022 file and store it in ram disk.

N.B. While it is possible to un-delete files onto the same volume, if you
do this you may overwrite the file you are trying to un-delete.

 E. RemoveDirEntry

*** WARNING ***

You should not use this tool without consulting with support first.

In the tools directory on your AFS install disk is a program called:

RemoveDirEntry

This program _forcefully_ removes a file or directory from an AFS
partition.

* It does _not_ free up the space allocated by the file/directory.

* The file/directory will not go into the .deldir.

* If you remove a directory _all_ the files in this directory and any
  sub-directories will be lost forever.

It should only be used in the unlikely circumstance that you have a
corrupted files or directory which can not be removed by any other means.

The only time this tool should be of any use is:

a) If there has been some physical corruption of the hard drive (Bad
blocks).

b) You have incorrectly set your maxtransfer or DMA Mask and in so doing
   caused a disk error.

c) Extreme memory corruption of a file or directory header at the time you
   were writing to disk.

   When checking with technical support prior to using this tool pleas
   have the following information ready:-

a) An output from "showconfig" (Type "showconfig" in any shell).

b) Your current AFS version (Type version "L:HardDiskAFS" in any shell).

c) Your MaxTransfer and DMA Mask setting (From HDToolBox).

d) Details of your system configuration (Hardware and software).

 10. BUGS

If you find something that you think doesn`t function properly please send
a bug report to Fourth Level Developments.

 11. Updates

Users are entitled to all updates within 6 months of purchase. The updates
are supplied free of charge if they are obtained by email/ftp. If you want
updates sent by post then please send a payment of £3.00 for Europe or
£4.50 outside. You must state your serial number (A 4 digit number on the
floppy disk) when applying for updates.

 Page 13

 12. Developers

If you are a developer and wish to:

 (a) develop tools to run with Ami-FileSafe or
 (b) programmes to take full advantage of future Ami-FileSafe features

then please contact Fourth Level Developments for a programmer`s
information pack. You will be asked to enter into a mutual confidentiality
agreement and provide some information about your project. Acceptance will
give you access to the AFS beta-testers forum.

 13. Registration

All copies of Ami-FileSafe are registered with the name of the purchaser.
If you acquire a copy from a trade source you must register your purchase
with Fourth Level Developments in order to obtain updates Up-dates are not
effective on unregistered copies.

 14. Support

If you have any problems, comments, or queries please contact us:

Email:afssupport@flevel.demon.co.uk
Tel:+44(0)117 985 4455
Fax:+44(0)117 955 9157
Mail:Fourth Level Developments
     31, Ashley Hill
     Montpelier
     Bristol
     BS6 5JA.
     England

If you are a trade customer (minimum order quantity  = 12) then please
ring the trade Desk: +44(0) 117 955 8225.

 Page 14
